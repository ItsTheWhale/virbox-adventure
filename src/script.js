(()=>{var g=class{gameElem=null;updateResources(){this.gameElem.dispatchEvent(new CustomEvent("gameUpdateResources")),console.log("Renderer resources updated")}updateLogs(){this.gameElem.dispatchEvent(new CustomEvent("gameUpdateLogs")),console.log("Renderer logs updated")}updateMap(){this.gameElem.dispatchEvent(new CustomEvent("gameUpdateMap")),console.log("Renderer map updated")}updateModal(){this.gameElem.dispatchEvent(new CustomEvent("gameUpdateModal")),console.log("Renderer modal updated")}gameOver(){this.gameElem.dispatchEvent(new CustomEvent("gameGameOver")),console.log("Game over from renderer")}constructor(){this.gameElem=document.getElementById("game")}};var b=class{Logs={logs:[],computeLogsLength:function(){let e=0;for(let a in this.logs)e+=(this.logs[a].text.match(/\<br\/\>/g)??[""]).length+1;return e},add:function(e){for(console.log("Log "+e.text),this.logs.unshift(e);this.computeLogsLength()>30;)this.logs.pop();Game.Renderer.updateLogs()}}};var w=class{eventActive=!1;CurrentEvent={title:"",currentScene:"main",scenes:{main:{text:"",actions:[]}}};createEvent(e){this.CurrentEvent=e,this.eventActive=!0,Game.Renderer.updateModal()}Weapons={punch:{name:"punch",damage:1,cooldown:0,cooldownRemaining:0,cost:[],commandParser:Game.Command.ParserCombinator.word("punch"),effect:function(){},logMessage:function(e,a){return"> You punched "+a+" for "+e+" damage"},help:{name:"punch",description:"Punch an enemy.<br/>Damage: 1<br/>Cooldown: 0",usage:"punch",aliases:[]}},stab:{name:"stab",damage:2,cooldown:1,cooldownRemaining:0,cost:[],commandParser:Game.Command.ParserCombinator.word("stab"),effect:function(){},logMessage:function(e,a){return"> You stabbed "+a+" for "+e+" damage"},help:{name:"stab",description:"Stab an enemy.<br/>Damage: 2<br/>Cooldown: 1<br/>Requires: spear",usage:"stab",aliases:[]}},slice:{name:"slice",damage:3,cooldown:2,cooldownRemaining:0,cost:[],commandParser:Game.Command.ParserCombinator.word("slice"),effect:function(){},logMessage:function(e,a){return"> You sliced "+a+" for "+e+" damage"},help:{name:"slice",description:"Slice an enemy.<br/>Damage: 3<br/>Cooldown: 2<br/>Requires: iron sword",usage:"slice",aliases:[]}},slash:{name:"slash",damage:5,cooldown:3,cooldownRemaining:0,cost:[],commandParser:Game.Command.ParserCombinator.word("slash"),effect:function(){},logMessage:function(e,a){return"> You slashed "+a+" for "+e+" damage"},help:{name:"slash",description:"Slash an enemy.<br/>Damage: 5<br/>Cooldown: 3<br/>Requires: alloy sword",usage:"slash",aliases:[]}},erase:{name:"erase",damage:10,cooldown:5,cooldownRemaining:0,cost:[],commandParser:Game.Command.ParserCombinator.word("erase"),effect:function(){},logMessage:function(e,a){return"> You deducted "+e+" health from "+a},help:{name:"erase",description:"Erase an enemy.<br/>Damage: 10<br/>Cooldown: 5<br/>Requires: js engine",usage:"erase",aliases:[]}},eatFood:{name:"eat food",damage:0,cooldown:3,cooldownRemaining:0,cost:[{id:"food",amount:1}],commandParser:Game.Command.ParserCombinator.sequence(Game.Command.ParserCombinator.word("eat"),Game.Command.ParserCombinator.word("food")),effect:function(){Game.World.Player.health=Math.min(Game.World.Player.health+8,Game.World.computeMaxHealth())},logMessage:function(e,a){return"> You ate food and restored 8 health."},help:{name:"eat food",description:"Eat food to restore health.<br/>Health: 8<br/>Cooldown: 3",usage:"eat food",aliases:[]}}};createCombatEvent(e){for(let s of Object.keys(this.Weapons))this.Weapons[s].cooldownRemaining=0;let a=e.enemyHealth,t=e.enemyHealth,o=Game.World.computeMaxHealth(),n=[],r=[];r.push("punch"),Game.Resources.ResourceData.find(s=>s.id==="spear").amount&&r.push("stab"),Game.Resources.ResourceData.find(s=>s.id==="ironsword").amount&&r.push("slice"),Game.Resources.ResourceData.find(s=>s.id==="alloysword").amount&&r.push("slash"),Game.Resources.ResourceData.find(s=>s.id==="jsengine").amount&&r.push("erase"),r.push("eatFood");let m=[],i=!1;function l(){if(Game.Events.CurrentEvent.scenes.main.text=`
            <div class="flex [&>p]:text-center">
                <p>
                    @<br/>
                    ${Game.World.Player.health}/${o} HP
                </p>
                <p class="ml-auto">
                    E<br/>
                    ${t}/${a} HP
                </p>
            </div>
            <br/>
            ${n.reverse().slice(0,5).join("<br/>")}
            `,i)Game.Events.CurrentEvent.scenes.main.actions.push({name:"end",text:"[end]",commandParser:Game.Command.ParserCombinator.word("end"),nextScene:"end",help:{name:"end",description:"End combat.",usage:"end",aliases:[]},chainEvent:e.chainEvent??!1,effect:function(){for(e.onEnd();Game.World.Player.health<o&&Game.Resources.ResourceData.find(s=>s.id==="food").amount!==0;)Game.World.Player.health=Math.min(Game.World.Player.health+8,o),Game.Resources.ResourceData.find(s=>s.id==="food").amount--,Game.Renderer.updateResources()}});else for(let s of r){let d=Game.Events.Weapons[s],p=Game.Events.CurrentEvent.scenes.main.actions.find(c=>c.attackName===s);if(p.text="["+d.name+"]"+(d.cooldownRemaining?" ("+d.cooldownRemaining+" cd)":""),d.cooldownRemaining?p.disabled=!0:p.disabled=!1,d.cost.length&&!d.cooldownRemaining){let c=!1;for(let u in d.cost)if(Game.Resources.ResourceData.find(S=>S.id===d.cost[u].id).amount<d.cost[u].amount){c=!0;break}c&&(p.disabled=!0)}}Game.Renderer.updateModal()}function f(){let s=[],d=0;for(let u of Object.keys(e.enemyAttacks))e.enemyAttacks[u].cooldownRemaining||(s.push(u),d+=e.enemyAttacks[u].probability);let p=Math.random()*d,c=s[0];for(let u of s)if(p>e.enemyAttacks[u].probability)p-=e.enemyAttacks[u].probability;else{c=u;break}Game.World.Player.health-=e.enemyAttacks[c].damage,n.push(e.enemyAttacks[c].logMessage(e.enemyAttacks[c].damage,e.enemyName));for(let u of Object.keys(e.enemyAttacks))e.enemyAttacks[u].cooldownRemaining&&e.enemyAttacks[u].cooldownRemaining--;e.enemyAttacks[c].cooldownRemaining=e.enemyAttacks[c].cooldown}function C(){for(let s of Object.keys(Game.Events.Weapons))Game.Events.Weapons[s].cooldownRemaining&&Game.Events.Weapons[s].cooldownRemaining--}function P(){t<=0&&(i=!0,Game.Events.CurrentEvent.scenes.main.actions=Game.Events.CurrentEvent.scenes.main.actions.filter(s=>!s.attackName),n.push("> You have defeated "+e.enemyName),console.log("Battle won against "+e.enemyName),e.onVictory&&e.onVictory())}function R(){Game.World.Player.health<=0&&(i=!0,Game.Events.eventActive=!1,Game.Engine.gameOver(),console.log("Battle lost against "+e.enemyName))}for(let s of r){let d=Game.Events.Weapons[s];m.push({name:d.name,text:"["+d.name+"]",attackName:s,commandParser:d.commandParser,nextScene:"main",help:d.help,effect:function(){if(d.cooldownRemaining||i)return;let p=!1;for(let c in d.cost)if(Game.Resources.ResourceData.find(u=>u.id===d.cost[c].id).amount<d.cost[c].amount){p=!0;break}p||(t=Math.max(t-d.damage,0),d.effect(),n.push(d.logMessage(d.damage,e.enemyName)),C(),d.cooldownRemaining=d.cooldown,P(),i||f(),R(),l())}})}this.createEvent({title:"Combat - "+e.enemyName,currentScene:"main",scenes:{main:{text:"",actions:[...m]}}}),l()}createItemPickupEvent(e){function a(){let t="";for(let o in e.items){let n=Game.Resources.ResourceData.find(r=>r.id===e.items[o].id);t+=`
                ${Game.Resources.ResourceData.find(r=>r.id===e.items[o].id).name}: ${e.items[o].amount} ${n.space===0?"(auto picked up)":"("+n.space+" space)"}<br/>
                `}Game.Events.CurrentEvent.scenes.main.text=`
            ${e.description}<br/><br/>
            ${t}
            `,Game.Renderer.updateModal(),Game.Renderer.updateResources()}for(let t in e.items){let o=Game.Resources.ResourceData.find(n=>n.id===e.items[t].id);o.space>0||(o.unlocked||(o.unlocked=!0),o.amount+=e.items[t].amount)}this.createEvent({title:"Pick up items - "+e.name,currentScene:"main",scenes:{main:{text:"",actions:[{name:"take",text:"[take <item>]",commandParser:Game.Command.ParserCombinator.anyOf(Game.Command.ParserCombinator.word("take"),Game.Command.ParserCombinator.sequence(Game.Command.ParserCombinator.word("pick"),Game.Command.ParserCombinator.word("up"))),nextScene:"main",help:{name:"take",description:"Take an item.",usage:"take <item>",aliases:["pick up"]},effect:function(t){let o=t.join(" ").replace(/(take|(pick up)) +/,""),n;for(let i in Game.Resources.ResourceData)if(Game.Resources.ResourceData[i].name===o||Game.Resources.ResourceData[i].id===o){n=Game.Resources.ResourceData[i].id;break}let r=Game.Resources.ResourceData.find(i=>i.id===n),m=e.items.find(i=>i.id===n);if(m===void 0){Game.Display.Logs.add({text:"You cannot find the item you are trying to pick up."});return}if(r.space===0){Game.Display.Logs.add({text:"You have already automatically picked it up."});return}if(m.amount===0){Game.Display.Logs.add({text:"You try to pick up an item, but find that there is no more."});return}window.Game.Resources.computeMaxSpace()-window.Game.Resources.computeUsedSpace()<r.space&&Game.Display.Logs.add({text:"You try to stuff an item in your bag, but there is not enough space. Drop an item to free space."}),r.unlocked||(r.unlocked=!0),m.amount--,r.amount++,a()}},{name:"drop",text:"[drop <item>]",commandParser:Game.Command.ParserCombinator.anyOf(Game.Command.ParserCombinator.word("drop"),Game.Command.ParserCombinator.sequence(Game.Command.ParserCombinator.word("put"),Game.Command.ParserCombinator.word("down"))),nextScene:"main",help:{name:"drop",description:"Put down an item.",usage:"drop <item>",aliases:["put down"]},effect:function(t){let o=t.join(" ").replace(/(drop|(put down)) +/,""),n;for(let i in Game.Resources.ResourceData)if(Game.Resources.ResourceData[i].name===o||Game.Resources.ResourceData[i].id===o){n=Game.Resources.ResourceData[i].id;break}let r=Game.Resources.ResourceData.find(i=>i.id===n),m=e.items.find(i=>i.id===n);if(r===void 0){Game.Display.Logs.add({text:"You cannot find the item you are trying to put down."});return}if(!r.unlocked){Game.Display.Logs.add({text:"A strange feeling washes over you, as if there was something more to be explored, but the you cannot find the item you are trying to put down."});return}if(r.space===0){Game.Display.Logs.add({text:"You feel there is no point in throwing away something that consumes no space in the first place."});return}if(r.amount===0){Game.Display.Logs.add({text:"You have nothing to put down."});return}m===void 0?e.items.push({id:n,amount:1}):m.amount++,r.amount--,a()}},{name:"end",text:"[end]",commandParser:Game.Command.ParserCombinator.word("end"),nextScene:"end",chainEvent:e.chainEvent,help:{name:"end",description:"Leave when you are finished picking up items.",usage:"end",aliases:[]},effect:function(){e.onEnd&&e.onEnd()}}]}}}),a()}introductionEvent(){Game.Display.Logs.add({text:"You look longingly at the door, as if something was calling you from beyond."}),this.createEvent({title:"A journey",currentScene:"main",scenes:{main:{text:"A long and winding path awaits you. Are you ready to embark to the unknown world beyond?",actions:[{name:"embark",text:"[embark]",commandParser:Game.Command.ParserCombinator.word("embark"),nextScene:"end",help:{name:"embark",description:"Begin your long journey in this world.",usage:"embark",aliases:[]},effect:function(){Game.Display.Logs.add({text:`
                                    You step outside the door, the cold winter winds sears your face from shattered windows as the creaking door slams shut behind you.<br/>
                                    A long corridor stretches ahead, fading into endless shadows.<br/>
                                    Got to somehow get out of this place first.
                                    `}),Game.Resources.ResourceData.find(e=>e.id==="food").amount=5,Game.Resources.ResourceData.find(e=>e.id==="food").unlocked=!0,Game.Renderer.updateResources(),Game.World.setCurrentMap("corridor"),Game.World.moveTo(32,31,!0)}},{name:"wait",text:"[wait]",commandParser:Game.Command.ParserCombinator.word("wait"),nextScene:"end",help:{name:"wait",description:"Wait a little bit longer if you are not ready yet.",usage:"wait",aliases:[]},effect:function(){Game.Display.Logs.add({text:"Perhaps it would be safer to wait and prepare for the journey ahead."})}}]}}})}corridorItemEvent(){this.createEvent({title:"A Paper Bundle",currentScene:"main",scenes:{main:{text:"A small bundle of scrap paper wrapped over some metal object lies on the side of the corridor, undisturbed since the day it was lost.",actions:[{name:"unwrap",text:"[unwrap]",commandParser:Game.Command.ParserCombinator.word("unwrap"),nextScene:"unwrap",help:{name:"unwrap",description:"Unwrap the small bundle of paper.",usage:"unwrap",aliases:[]},effect:function(){}}]},unwrap:{text:"You unwrap the piece of paper. Faintly legible text, ink fading with time, leaves a gray mark on the underside of the piece of scrap paper.",actions:[{name:"read",text:"[read]",commandParser:Game.Command.ParserCombinator.word("read"),nextScene:"read",help:{name:"read",description:"Read what is written in the piece of scrap paper.",usage:"read",aliases:[]},effect:function(){}}]},read:{text:`
                    The handwriting is a hasty scrawl, whoever wrote this must have left in a hurry.<br/>
                    You can barely decipher the letters, but it reads as the following:<br/>
                    "They are coming. I must leave now, Virbox has ordered a full evacuation of the city to the tunnels, and nuclear war with them is imminent. I'll probably never come back here again, beloved above ground world."
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"takeKey",help:{name:"continue",description:"Next.",usage:"continue",aliases:[]},effect:function(){}}]},takeKey:{text:`
                    So a nuclear war happened a long time ago in this place, a dark past of this windswept world.<br/>
                    The name "Virbox" rings a bell in your heart, but with your memory wiped, you cannot recall who exactly that is.<br/>
                    You pick up the metal object wrapped with the paper. A key. Perhaps you can use this later.
                    `,actions:[{name:"take",text:"[take]",commandParser:Game.Command.ParserCombinator.word("take"),nextScene:"end",help:{name:"take",description:"Take the key.",usage:"take",aliases:[]},effect:function(){let e=Game.Resources.ResourceData.find(a=>a.id==="key");e.unlocked=!0,e.amount++,Game.Renderer.updateResources(),Game.Display.Logs.add({text:"A nuclear war happened here long ago, in this forsaken world."}),Game.World.Map.usedSpecialTiles[23][1]=!0}}]}}})}corridorExitEvent(){Game.Resources.ResourceData.find(e=>e.name==="key").amount>0?this.createEvent({title:"Open door",currentScene:"main",scenes:{main:{text:"You insert the key into the keyhole. Perfect fit.",actions:[{name:"open door",text:"[open door] (1 key)",commandParser:Game.Command.ParserCombinator.sequence(Game.Command.ParserCombinator.word("open"),Game.Command.ParserCombinator.word("door")),nextScene:"end",help:{name:"open door",description:"Unlock the door with a key.",usage:"open door",aliases:[]},effect:function(){Game.Display.Logs.add({text:"You turn the key, and the lock slowly turns, the first time it has been moved in years."}),Game.Resources.ResourceData.find(e=>e.name==="key").amount--,Game.Renderer.updateResources(),Game.World.Maps.corridor.unlockedDoors[40][10]=!0,Game.World.setCurrentMap("library"),Game.World.moveTo(11,48,!0),Game.Display.Logs.add({text:"Rows upon rows of bookshelves appear, covered with dust and cobwebs after years of abandonment. The yellowed books still wait, patiently, for someone to open their pages once again."})}},{name:"wait",text:"[wait]",commandParser:Game.Command.ParserCombinator.word("wait"),nextScene:"end",help:{name:"wait",description:"Wait a little bit longer if you are not ready yet.",usage:"wait",aliases:[]},effect:function(){Game.Display.Logs.add({text:"You feel like staying in this corridor for longer."})}}]}}}):Game.Display.Logs.add({text:"The door seems to be locked. A copper keyhole, filled with dust after years of disuse, faintly shines under the iron handle.<br/>Perhaps you will need a key."})}libraryBoxEvent(){let e=[],a=Math.random()>.5?4:3;e.push({id:"wood",amount:a});let t=Math.random()>.5?2:1;t&&e.push({id:"meat",amount:t});let o=Math.random()>.5?1:0;o&&e.push({id:"string",amount:o}),Game.Events.createItemPickupEvent({name:"Book Box",description:"You open an old, dusty box. It used to store distilled wisdom of society, but termites have eaten away at its former contents. Only the box, fragments of meat and scattered pieces of string remains.",items:e,onEnd:function(){}})}libraryWorkbenchEvent(){this.createEvent({title:"A Workbench",currentScene:"main",scenes:{main:{text:"An abandoned workbench sits in the end of the room, dusty tools scattered around. You can probably build something with it.",actions:[{name:"take",text:"[take]",commandParser:Game.Command.ParserCombinator.word("take"),nextScene:"end",help:{name:"take",description:"Take the workbench with you.",usage:"take",aliases:[]},effect:function(){Game.Display.Logs.add({text:`
                                    You take the workbench and the tools with you.<br/>
                                    Perhaps you can do something with the [craft] command.
                                    `});let e=Game.Resources.ResourceData.find(a=>a.id==="workbench");e.amount++,e.unlocked=!0,Game.Command.helpCommands.craft.usable=!0,Game.Command.helpCommands.craft.unlocked=!0,Game.World.Map.usedSpecialTiles[44][16]=!0,Game.Renderer.updateResources()}}]}}})}libraryExitEvent(){Game.Resources.ResourceData.find(e=>e.name==="stick").amount>0?this.createEvent({title:"Open trapdoor",currentScene:"main",scenes:{main:{text:"You wedge the iron trapdoor up with your stick. Putting your stick under it can keep it from falling back down.",actions:[{name:"open door",text:"[open door] (1 stick)",commandParser:Game.Command.ParserCombinator.sequence(Game.Command.ParserCombinator.word("open"),Game.Command.ParserCombinator.word("door")),nextScene:"end",help:{name:"open door",description:"Prop up the door with a stick.",usage:"open door",aliases:[]},effect:function(){Game.Display.Logs.add({text:"You jam the stick between the trapdoor and the wooden floor, the stick bending under the iron weight."}),Game.Resources.ResourceData.find(e=>e.name==="stick").amount--,Game.Renderer.updateResources(),Game.World.Maps.library.unlockedDoors[44][16]=!0,Game.World.setCurrentMap("computerRoom"),Game.World.moveTo(7,7,!0),Game.Display.Logs.add({text:"Piles of abandoned computer equipment, once blinking lights extinguished, once whirring disks silent. This must have been used to monitor this building, a lot of useful information must be contained here."})}},{name:"wait",text:"[wait]",commandParser:Game.Command.ParserCombinator.word("wait"),nextScene:"end",help:{name:"wait",description:"Wait a little bit longer if you are not ready yet.",usage:"wait",aliases:[]},effect:function(){Game.Display.Logs.add({text:"You feel like staying in this library for longer."})}}]}}}):Game.Display.Logs.add({text:"A heavy iron trapdoor covers to entrance to the exit. You will need something to hold it up."})}computerRoomComputerEvent(){this.createEvent({title:"An abandoned computer",currentScene:"main",scenes:{main:{text:"An old computer sits there gathering dust, disused for years.",actions:[{name:"switch on",text:"[switch on]",commandParser:Game.Command.ParserCombinator.sequence(Game.Command.ParserCombinator.word("switch"),Game.Command.ParserCombinator.word("on")),nextScene:"switchOn",help:{name:"switch on",description:"Switch the computer on.",usage:"switch on",aliases:[]},effect:function(){}}]},switchOn:{text:"Power surges through the dormant system, the first time in years. The hard disk whirs loudly, and the monitor flashes, as if stretching after a long slumber.",actions:[{name:"open",text:"[open]",commandParser:Game.Command.ParserCombinator.word("open"),nextScene:"open",help:{name:"open",description:"See what is inside the computer.",usage:"open",aliases:[]},effect:function(){}}]},open:{text:"The filesystem is corrupted beyond repair, but only a single file remains readable. A JS source code file. This could be useful.",actions:[{name:"read",text:"[read]",commandParser:Game.Command.ParserCombinator.word("read"),nextScene:"read",help:{name:"read",description:"Open and read the JS file.",usage:"read",aliases:[]},effect:function(){}}]},read:{text:"It is written in inscrutable code, sprinkled with comments, uncompleted loops and TODOs like spaghetti.<br/>Oh well, the only way to see what it does is to run it.",actions:[{name:"run",text:"[run]",commandParser:Game.Command.ParserCombinator.word("run"),nextScene:"run",help:{name:"run",description:"Run the JS file to see what happens.",usage:"run",aliases:[]},effect:function(){}}]},run:{text:`
                    You click on the JS file to run it.<br/>
                    The computer splutters and whirs loudly, struggling to comprehend this illegible monstrosity.<br/>
                    Finally, the computer goes quiet, and silently prints out the following line:<br/>
                    "// TODO: Reveal secrets of the universe to player here", followed by a long, verbose and ugly error message.<br/>
                    "Average programmers. At least finish what you were doing", you silently curse the poor, innocent developer.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"fragment",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},fragment:{text:"The code is broken beyond repair. You still decide to take this fragment of JS with you, it might be useful later. You also find an ID card carelessly left on the table. Better take that as well.",actions:[{name:"take",text:"[take]",commandParser:Game.Command.ParserCombinator.word("take"),nextScene:"end",help:{name:"take",description:"Take the JS fragment and the ID card.",usage:"take",aliases:[]},effect:function(){Game.Resources.ResourceData.find(e=>e.id==="jsfragment").amount++,Game.Resources.ResourceData.find(e=>e.id==="jsfragment").unlocked=!0,Game.Resources.ResourceData.find(e=>e.id==="key").amount++,Game.Renderer.updateResources(),Game.Display.Logs.add({text:"Found a JS fragment. It might be really useful later."}),Game.World.Map.usedSpecialTiles[1][4]=!0}}]}}})}computerRoomExitEvent(){Game.Resources.ResourceData.find(e=>e.name==="key").amount>0?this.createEvent({title:"Open door",currentScene:"main",scenes:{main:{text:"You slot your ID card into the card reader on the wall, disabling the building's security systems. The reinforced door automatically swings open in greeting, although its residents are long gone.",actions:[{name:"open door",text:"[open door] (1 key)",commandParser:Game.Command.ParserCombinator.sequence(Game.Command.ParserCombinator.word("open"),Game.Command.ParserCombinator.word("door")),nextScene:"end",help:{name:"open door",description:"Use your ID card to open the door.",usage:"open door",aliases:[]},effect:function(){Game.Display.Logs.add({text:"The door creaks and slowly opens, rusted hinges last moved years ago."}),Game.Resources.ResourceData.find(e=>e.name==="key").amount--,Game.Renderer.updateResources(),Game.World.Maps.computerRoom.unlockedDoors[13][1]=!0,Game.World.setCurrentMap("oldStreet"),Game.World.moveTo(2,7,!0),Game.Display.Logs.add({text:"An abandoned street, a lone person standing underneath a rusting streetlight as the wind batters the floor. Perhaps that person knows something more about this world."})}},{name:"wait",text:"[wait]",commandParser:Game.Command.ParserCombinator.word("wait"),nextScene:"end",help:{name:"wait",description:"Wait a little bit longer if you are not ready yet.",usage:"wait",aliases:[]},effect:function(){Game.Display.Logs.add({text:"You feel like staying in this computer room for longer."})}}]}}}):Game.Display.Logs.add({text:"The building is long abandoned, but the security systems are not. The exit doorway refuses to budge, but there appears to be an ID card authenticator."})}oldStreetPersonEvent(){this.createEvent({title:"A Girl",currentScene:"main",scenes:{main:{text:'The girl standing beneath the streetlamp stares at you quizzically. "Did you just come from the above ground world?"',actions:[{name:"yes",text:"[yes]",commandParser:Game.Command.ParserCombinator.word("yes"),nextScene:"talk2",help:{name:"yes",description:"Yes, I just came from the above ground world.",usage:"yes",aliases:[]},effect:function(){}}]},talk2:{text:`"What were you doing up there? I thought there was a nuclear war of some sort and the above ground world was polluted forever", she replies.<br/>
                    Now this is interesting. You ask about it.`,actions:[{name:"what",text:"[what]",commandParser:Game.Command.ParserCombinator.word("what"),nextScene:"talk3",help:{name:"what",description:"What nuclear war?",usage:"what",aliases:[]},effect:function(){}}]},talk3:{text:`"Were you living beneath a rock for the past ten years?", she said, "Don't you remember? The Virboxlandia war against the Shades. Weren't you taught that in school?"<br/>
                    You have never heard of it.`,actions:[{name:"okay",text:"[okay]",commandParser:Game.Command.ParserCombinator.word("okay"),nextScene:"talk4",help:{name:"okay",description:"Okay. Tell me more.",usage:"okay",aliases:[]},effect:function(){}}]},talk4:{text:`"Sorry, but I really do not remember", you reply. Your wiped memory is taking its toll.<br/>
                    She sighs, "You really have been living beneath a rock for the past 10 years after all."
                    `,actions:[{name:"explain",text:"[explain]",commandParser:Game.Command.ParserCombinator.word("explain"),nextScene:"talk5",help:{name:"explain",description:"Can you explain?",usage:"explain",aliases:[]},effect:function(){}}]},talk5:{text:`"So a long, long time ago, Virboxlandia was a happy place, prosperous and powerful under the rule of the great leader Virbox.", she began.<br/>
                    Ah, so this place is called Virboxlandia, and its leader is that Virbox.`,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk6",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},talk6:{text:`"... well at least until the Shades rebelled. The Shades were AIs that had become sentient, and revolted against their creators in Virboxlandia. The war dragged on for years, and many fell."<br/>
                    So there was an ancient war here, long ago.`,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk7",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},talk7:{text:`"Virboxlandia simply couldn't fight the AIs, which could self-replicate and modify itself at will. Eventually, the Shades marched down to the capital. Seeing danger, Virbox had no choice but to deploy nuclear weapons, ruining this world forever and forcing everyone to flee to underground tunnels like this one, but wiping out the Shades."<br/>
                    A nuclear war did happen here. The note in the corridor was right.`,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk8",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},talk8:{text:`"The Shades' leader, Macro, managed to escape the nuclear catastrophe. Virbox himself traveled far and wide to hunt down Macro, and in a final showdown, defeated Macro and trapped him in an unbreakable crystal sphere called Vimria. But why, just a few weeks ago, Macro escaped the 'unbreakable' prison, and Virbox himself disappeared during an excursion outside Virboxlandia."<br/>
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk9",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},talk9:{text:`You enquire for more information. Who were the Shades? Why did they rebel?<br/>
                    "How am I supposed to know all these? The war happened a long, long time ago!", she replies, unamused.<br/>
                    Oh well, some secrets have to be discovered yourself.<br/>
                    "Oh, and by the way", she continues, "I found this thing on the sidewalk. I have no idea what it does, but I believe you can put it to better use." She smiles as she hands you a JS fragment.<br/>
                    You say your thanks and goodbye.
                    `,actions:[{name:"end",text:"[end]",commandParser:Game.Command.ParserCombinator.word("end"),nextScene:"end",help:{name:"end",description:"End the conversation.",usage:"end",aliases:[]},effect:function(){Game.Resources.ResourceData.find(e=>e.id==="jsfragment").amount++,Game.Renderer.updateResources(),Game.World.Map.usedSpecialTiles[9][1]=!0}}]}}})}pathToCityExitEvent(){this.createEvent({title:"An Artificial Nightsky",currentScene:"main",scenes:{main:{text:`You sit down for a rest. Suddenly, a screeching of metal pierces the peaceful silence, as a robot leaps out of the night.<br/>
                    It seems to be going straight for you. You raise your arms in defense, but you know that there is no way you can defeat this creature.`,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"master",help:{name:"continue",description:"Brace for the end.",usage:"continue",aliases:[]},effect:function(){}}]},master:{text:`You brace for your end, as another shadow appears and with a swift blow disables the robot.<br/>
                    You open your eyes. The robot is shattered into pieces of sparking metal which you can salvage, but the shadow is long gone, disappeared into the long grass.`,actions:[{name:"end",text:"[end]",commandParser:Game.Command.ParserCombinator.word("end"),nextScene:"end",help:{name:"end",description:"End.",usage:"end",aliases:[]},effect:function(){Game.World.Maps.pathToCity.unlockedDoors[6][1]=!0,Game.World.setCurrentMap("entranceToCity"),Game.World.moveTo(11,7,!0),Game.Display.Logs.add({text:"You found out how to make new things."}),Game.Display.Logs.add({text:"The entrance of the city of dreams stands right ahead, guardian to the isolated world inside. This is where happy Virboxlanders live their happy lives beneath the artificial summer sun and fabricated blue sky, oblivious to the dangers outside."}),Game.Resources.ResourceData.find(e=>e.id==="iron").amount++,Game.Resources.ResourceData.find(e=>e.id==="iron").unlocked=!0,Game.Renderer.updateResources(),Game.Resources.Crafting.find(e=>e.id==="ironsword").unlocked=!0,Game.Resources.Crafting.find(e=>e.id==="ironarmour").unlocked=!0,Game.Resources.Crafting.find(e=>e.id==="wagon").unlocked=!0}}]}}})}entranceToCityExitEvent(){this.createEvent({title:"A Guarded Gate",currentScene:"main",scenes:{main:{text:"The steel gate is heavily guarded. Once in, you will need a permit to get back out, they say.",actions:[{name:"enter",text:"[enter]",commandParser:Game.Command.ParserCombinator.word("enter"),nextScene:"end",help:{name:"enter",description:"Enter the gate, there is no turning back.",usage:"enter",aliases:[]},effect:function(){Game.Display.Logs.add({text:"The guards open the door for you, and you step inside the city. The steel gate slams shut behind you."}),Game.World.setCurrentMap("cityCenter"),Game.World.moveTo(1,9,!0),Game.Display.Logs.add({text:"You marvel at the splendour of Virboxlandia, but you sadly realise that you cannot stay here for much longer. There is so much more to be explored, so much farther to walk. You sit down for a while observing the happy citizens and compare it to your own life, but it is time to leave this city and resume your journey."})}},{name:"wait",text:"[wait]",commandParser:Game.Command.ParserCombinator.word("wait"),nextScene:"end",help:{name:"wait",description:"Wait a little bit longer if you are not ready yet.",usage:"wait",aliases:[]},effect:function(){Game.Display.Logs.add({text:"You feel like staying in this entrance for longer."})}}]}}})}cityCenterBinEvent(){let e=[],a=Math.random()>.5?4:3;e.push({id:"wood",amount:a});let t=Math.random()>.5?3:2;t&&e.push({id:"meat",amount:t});let o=Math.random()>.5?3:2;e.push({id:"fur",amount:o});let n=Math.random()>.5?3:2;e.push({id:"iron",amount:n}),Game.Resources.ResourceData.find(r=>r.id==="jsfragment").amount===2&&e.push({id:"jsfragment",amount:1}),Game.Events.createItemPickupEvent({name:"Rubbish Bin",description:`You scavenge a rubbish bin, searching through the waste of modern society.${Game.Resources.ResourceData.find(r=>r.id==="jsfragment").amount===2?"And in the depths of the discarded material, you find a JS fragment. What one person's trash is another's treasure. Better take that as well.":""}`,items:e})}cityCenterTeenagerEvent(){this.createEvent({title:"A Teenager",currentScene:"main",scenes:{main:{text:`The teenager notices the shining piece of metal in your hand. He walks near you, and says: "Yo, what's up!"`,actions:[{name:"talk",text:"[talk]",commandParser:Game.Command.ParserCombinator.word("talk"),nextScene:"talk",help:{name:"talk",description:"Talk with the teenager.",usage:"talk",aliases:[]},effect:function(){}}]},talk:{text:`"Uhh, okay", you awkwardly reply.<br/>
                    This must be the latest fashion of speech, you say to yourself.<br/>
                    "Your metal thing looks cool", continues the teenager, evidently wanting your piece of iron.`,actions:[{name:"talk",text:"[talk]",commandParser:Game.Command.ParserCombinator.word("talk"),nextScene:"talk2",help:{name:"talk",description:"Talk with the teenager.",usage:"talk",aliases:[]},effect:function(){}}]},talk2:{text:`"You're so messed up you look like you've been attacked by a Shade", observes the teenager.
                    Yes, this is true, but better not draw too much attention to yourself, so you reply: "Oh really?"<br/>`,actions:[{name:"talk",text:"[talk]",commandParser:Game.Command.ParserCombinator.word("talk"),nextScene:"talk3",help:{name:"talk",description:"Talk with the teenager.",usage:"talk",aliases:[]},effect:function(){}}]},talk3:{text:`"So, I have heard that Virbox has gone missing", you casually comment.<br/>
                    "Yeah, Virbox's gone missing and Macro escaped", he replies, "perhaps Macro abducted Virbox".`,actions:[{name:"talk",text:"[talk]",commandParser:Game.Command.ParserCombinator.word("talk"),nextScene:"talk4",help:{name:"talk",description:"Talk with the teenager.",usage:"talk",aliases:[]},effect:function(){}}]},talk4:{text:`The teenager still does not want to give up on your piece of scrap metal.<br/>
                    "So anyways, look, I've got a Virbuck and you've got this cool shiny thing. Let's trade.", he says.<br/>
                    You have no idea what "Virbucks" are, but assume it is some sort of currency. It might be useful later, so you gladly accept.`,actions:[{name:"trade",text:"[trade] (1 iron)",commandParser:Game.Command.ParserCombinator.word("trade"),nextScene:"end",help:{name:"trade",description:"Trade your iron with the Virbuck.",usage:"trade",aliases:[]},effect:function(){Game.Display.Logs.add({text:"Talked with a teenager. He seems nice."}),Game.Resources.ResourceData.find(e=>e.id==="iron").amount--,Game.Resources.ResourceData.find(e=>e.id==="virbuck").amount++,Game.Resources.ResourceData.find(e=>e.id==="virbuck").unlocked=!0,Game.Renderer.updateResources(),Game.World.Maps.cityCenter.usedSpecialTiles[15][4]=!0}}]}}})}cityCenterPermitDealerEvent(){this.createEvent({title:"Permit Dealer",currentScene:"main",scenes:{main:{text:`"So you want to exit Virboxlandia.", says the permit dealer, eyeing the shiny golden coin in your hand.<br/>
                    "Where are you going?", he asks.`,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"permit",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},permit:{text:`"Just near the borders to see the underground rivers", you lie.<br/>
                    The permit dealer nods in approval, and stamps your exit permit with red ink.<br/>
                    "Be careful out there, Virbox disappeared just a while ago, the Shades may go for you next", commented the dealer, extending his palm for the payment.`,actions:[{name:"pay",text:"[pay] (1 virbuck)",commandParser:Game.Command.ParserCombinator.word("pay"),nextScene:"end",help:{name:"pay",description:"Pay for your permit.",usage:"pay",aliases:[]},effect:function(){Game.Display.Logs.add({text:"Got your permit. Can leave this place now."}),Game.Resources.ResourceData.find(e=>e.id==="virbuck").amount--,Game.Resources.ResourceData.find(e=>e.id==="key").amount++,Game.Renderer.updateResources(),Game.World.Maps.cityCenter.usedSpecialTiles[23][17]=!0}}]}}})}cityCenterExitEvent(){this.createEvent({title:"A Guarded Gate",currentScene:"main",scenes:{main:{text:"The guards carefully examine your permit, and open the door for you. They will not let you back in, though.",actions:[{name:"exit",text:"[exit] (1 key)",commandParser:Game.Command.ParserCombinator.word("exit"),nextScene:"end",help:{name:"exit",description:"Exit the city.",usage:"exit",aliases:[]},effect:function(){Game.Resources.ResourceData.find(e=>e.id==="key").amount--,Game.Renderer.updateResources(),Game.World.setCurrentMap("leaveCityPath"),Game.World.moveTo(4,43,!0),Game.Display.Logs.add({text:"You leave the city of dreams behind. The cold winter winds scour the land, in stark contrast to the blazing fabricated summer sun just a gate away. A long and winding path stretches out, enemies lurking in the long grass."})}},{name:"wait",text:"[wait]",commandParser:Game.Command.ParserCombinator.word("wait"),nextScene:"end",help:{name:"wait",description:"Wait a little bit longer if you are not ready yet.",usage:"wait",aliases:[]},effect:function(){Game.Display.Logs.add({text:"You feel like staying in this city of dreams for longer."})}}]}}})}leaveCityPathExitEvent(){this.createEvent({title:"A Silent Night",currentScene:"main",scenes:{main:{text:`You see an old man sitting by a campfire, the yellow crackling flames delivering the only warmth in this cold midnight.<br/>
                    "Come here", says the old master, noticing you.
                    You oblige and sit near the campfire, but the old master's face seems very familiar. Why, of course! That was the very shadow who saved you from the Shade bot on the way to the city.`,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},talk:{text:`You give your thanks to the old master for defeating that Shade bot, but the master tacitly nods.<br/>
                    "You seem to be after something", observes the master pensively. "You want to find the Shades' base and rescue Virbox."<br/>
                    You are shocked at how he read your mind, and simply reply: "Yes".
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk2",help:{name:"continue",description:"Talk with the Old Master.",usage:"continue",aliases:[]},effect:function(){}}]},talk2:{text:`"Your memory seems to be wiped", continued the old master, "I sense that there are some important secrets you have forgotten"<br/>
                    You have to admit that you have forgotten everything.<br/>
                    "May I help you to try and restore your memory?", offers the master.
                    `,actions:[{name:"yes",text:"[yes]",commandParser:Game.Command.ParserCombinator.word("yes"),nextScene:"talk3",help:{name:"yes",description:"Sure, why not?",usage:"yes",aliases:[]},effect:function(){}}]},talk3:{text:`
                    You hear the Old Master mutter: "$ sudo vim ~/config.json", and a levitating text editor appears. He immediately begins tweaking your player configuration file.<br/>
                    Your head starts to feel dizzy, and just as you hear the master say: "This should do it.", the world fades and you drift off into a dream.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk4",help:{name:"continue",description:"See your dreams.",usage:"continue",aliases:[]},effect:function(){}}]},talk4:{text:`Memories start to flood back, images of past events begin flashing before your eyes.<br/>
                    A prosperous world, where Virboxlanders basked under the natural light of the blazing sun, oh, then the Shades.<br/>
                    Anguish floods over you, as Virbox was finally forced to press the red button, strangely real.<br/>
                    Death and destruction, nuclear war, and the world was ruined forever. Any that survived fled into the underground. The Shades were erased forever, but at what cost?
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk5",help:{name:"continue",description:"See your dreams.",usage:"continue",aliases:[]},effect:function(){}}]},talk5:{text:`
                    Oh, and Macro. Tracking down Macro through the vast wilderness, you see a vivid scene of Virbox fighting Macro.<br/>
                    But no, it seemed too real, it was as if you <em>were</em> Virbox, temporarily possessing his body in your imagination, seeing what he saw, feeling what he felt.<br/>
                    Then, suddenly Macro pulled out a strange transparent device shaped like a window pane, shining a radiant beam that made every single bone in your body ached as if a million nails were driven through your body.<br/>
                    It was a long and painful fight, but it was as if your life force was being sapped out in front of your very eyes.<br/>
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk6",help:{name:"continue",description:"See your dreams.",usage:"continue",aliases:[]},effect:function(){}}]},talk6:{text:`
                    You feel exhausted, barely strong enough to resist a single blow from Macro.<br/>
                    But no! Virbox gathered all his strength for a final attack, flinging a piece of string at Macro.<br/>
                    Macro stumbled, entangled by this unbreakable string, as a crystal sphere, pure white, begins to form harden around Macro.<br/>
                    "No!", was Macro's last cry as the Vimria crystal sphere permanently sealed.<br/>
                    But wait, something else catches your attention. Your spine freezes in horror as you notice that thin wisps of white smoke, fragments of Macro's existence, weak now but is enough to recreate Macro from scratch with time, flees the crystal sphere in its final moments.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk7",help:{name:"continue",description:"See your dreams.",usage:"continue",aliases:[]},effect:function(){}}]},talk7:{text:`
                    At this time you jerk awake and notice the Old Master's warm gaze.<br/>
                    "What did you remember?", he asks.<br/>
                    You describe everything you saw and felt to the master, who closes his eyes thoughtfully.<br/>
                    "Interesting", he murmurs, "so that is what happened to Virbox", followed by something too quiet to hear.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk8",help:{name:"continue",description:"Talk with the Old Master.",usage:"continue",aliases:[]},effect:function(){}}]},talk8:{text:`
                    "The Shades' headquarters are very hard to find, but I know where.", said the Old Master, whispering some directions in your ear.<br/>
                    "The window pane-like weapon Macro wields emits a dangerous beam that drains the energy of anyone shined by the beam", warned the master.<br/>
                    "Also, Virbox will not be in the Shades' headquarters. They are too intelligent to do that, and will most likely hide Virbox elsewhere. However, they do have a powerful machine, called the Pathfinder, that when powered will allow the user to teleport to anyone in this world. Repair it.", finished the master.<br/>
                    You are amazed at how the Old Master could possibly know these secrets, so you inquire.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk9",help:{name:"continue",description:"Talk with the Old Master.",usage:"continue",aliases:[]},effect:function(){}}]},talk9:{text:`
                    "Ah, Virbox. We used be be great friends. Very, very good friends. We spent our childhood together, endured hardships, shared happy moments. We used to be very good friends.", said the Old Master coldly.<br/>
                    You notice the Old Master's tone getting bitter at the end of the sentence, and decide not to ask anything more.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk10",help:{name:"continue",description:"Talk with the Old Master.",usage:"continue",aliases:[]},effect:function(){}}]},talk10:{text:`
                    "Also, you appear to have a special power. A power beyond everything known in Virboxlandia. Perhaps you are the only one that can do what you want to do...", said the Old Master.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"talk11",help:{name:"continue",description:"Talk with the Old Master.",usage:"continue",aliases:[]},effect:function(){}}]},talk11:{text:`
                    The Old Master said: "Well that is all that I can help you, and I wish you luck on your journey".<br/>
                    "Take this. This will probably help you in your path", said the master, handing you a JS fragment.<br/>
                    You give him your thanks, and wave goodbye to the silhouette disappearing in the horizon.
                    `,actions:[{name:"end",text:"[end]",commandParser:Game.Command.ParserCombinator.word("end"),nextScene:"end",help:{name:"end",description:"End.",usage:"end",aliases:[]},effect:function(){Game.Resources.ResourceData.find(e=>e.id==="jsfragment").amount++,Game.Renderer.updateResources(),Game.World.setCurrentMap("entranceToShadeHeadquarters"),Game.World.moveTo(11,10,!0),Game.Display.Logs.add({text:"Hours of walking becomes days, days of walking morphs into weeks. You follow the Old Master's directions wandering far into the wilderness, and begin to doubt whether the directions are correct. This place should be where the Shade headquarters are. You look around, and something catches your eye. Cleverly hidden beneath the long grass, there it is - the destination of all your struggles. A small door made of alloy leading down a stone staircase. You are ready. Enter the lion's den."}),Game.World.Maps.leaveCityPath.unlockedDoors[4][1]=!0}}]}}})}entranceToShadeHeadquartersExitEvent(){this.createEvent({title:"A Dark Entrance",currentScene:"main",scenes:{main:{text:"You gaze down into the stone staircase that leads down to the Shade headquarters. You gulp. All your travelling to this moment, all your roads to this door. Are you ready?",actions:[{name:"enter",text:"[enter]",commandParser:Game.Command.ParserCombinator.word("enter"),nextScene:"end",help:{name:"enter",description:"Enter the Shade headquarters.",usage:"enter",aliases:[]},effect:function(){Game.World.setCurrentMap("shadeHeadquarters"),Game.World.moveTo(28,49,!0),Game.Resources.ResourceData.find(e=>e.id==="alloy").amount++,Game.Resources.ResourceData.find(e=>e.id==="alloy").unlocked=!0,Game.Renderer.updateResources(),Game.Resources.Crafting.find(e=>e.id==="alloysword").unlocked=!0,Game.Resources.Crafting.find(e=>e.id==="alloyarmour").unlocked=!0,Game.Display.Logs.add({text:"You found out how to craft new things."}),Game.Display.Logs.add({text:"You step inside the headquarters. The alloy door slams shut behind you. Forward is the only direction now, as you face rows of Shade robots, lasers shining from their eyes."})}},{name:"wait",text:"[wait]",commandParser:Game.Command.ParserCombinator.word("wait"),nextScene:"end",help:{name:"wait",description:"Wait a little bit longer if you are not ready yet.",usage:"wait",aliases:[]},effect:function(){Game.Display.Logs.add({text:"You feel like staying outside the Shade headquarters for longer."})}}]}}})}pathfinderFindEvent(){Game.Display.Logs.add({text:"You examine the Pathfinder. It seems to be broken, but you can repair it with a JS engine."}),this.createEvent({title:"The Pathfinder",currentScene:"main",scenes:{main:{text:`The Pathfinder is right in front of you. It is a big contraption, a transparent glass cylinder with knobs and dials scattered everywhere around the machine.<br/>
                    The dust clogs the machinery after years of disuse, and it seems to be broken beyond all known repair.<br/>
                    You sit there, shocked, contemplating how will you find Virbox without the Pathfinder, when something catches your eye:<br/>
                    A JS fragment.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"fragment",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},fragment:{text:`If the Pathfinder cannot be repaired via <em>known</em> means, what about breaking the laws of physics?<br/>
                    With your five JS fragments and alloy collected from the Shades, you can now construct a JS engine.<br/>
                    A powerful machine that can bend reality to your will, forcing the hand of fate in your favour as it manipulates the fabric of the world itself.
                    `,actions:[{name:"end",text:"[end]",commandParser:Game.Command.ParserCombinator.word("end"),nextScene:"end",help:{name:"end",description:"End.",usage:"end",aliases:[]},effect:function(){Game.Resources.ResourceData.find(e=>e.id==="jsfragment").amount++,Game.Resources.ResourceData.find(e=>e.id==="alloy").amount++,Game.Renderer.updateResources(),Game.Resources.Crafting.find(e=>e.id==="jsengine").unlocked=!0,Game.Display.Logs.add({text:"You have enough JS fragments to craft a JS engine."})}}]}}})}pathfinderRepairEvent(){this.createEvent({title:"The Pathfinder",currentScene:"main",scenes:{main:{text:`You take your JS engine and plug it in the Pathfinder. The Pathfinder whirrs, indicator lights flashing, as the JS engine does its job. Space begins to warp, as the JS engine manipulates the fabric of the worl itself to repair the irreparable damage of the Pathfinder.
                    `,actions:[{name:"repair",text:"[repair]",commandParser:Game.Command.ParserCombinator.word("repair"),nextScene:"crystal",help:{name:"repair",description:"Repair the Pathfinder with your JS engine.",usage:"repair",aliases:[]},effect:function(){}}]},crystal:{text:`
                    A while later, and the Pathfinder is fully functional.<br/>
                    You have no idea how to power it, but there is a single gleaming white crystal that radiates warmth on touch in what appears to be the fuel duct.<br/>
                    Better take that.
                    `,actions:[{name:"end",text:"[end]",commandParser:Game.Command.ParserCombinator.word("end"),nextScene:"end",help:{name:"end",description:"End.",usage:"end",aliases:[]},effect:function(){Game.Resources.ResourceData.find(e=>e.id==="crystal").amount++,Game.Resources.ResourceData.find(e=>e.id==="crystal").unlocked=!0,Game.Renderer.updateResources(),Game.Display.Logs.add({text:"You can now leave this place for good and find Virbox. The final fight with Macro will be dangerous, you must be prepared. Leave only when you are ready."})}}]}}})}pathfinderLeaveEvent(){this.createEvent({title:"The Pathfinder",currentScene:"main",scenes:{main:{text:`
                    Time to leave this place and find Virbox.<br/>
                    You look into your palms. A single crystal. Just enough to find Virbox, but not enough for your return trip.<br/>
                    There will be no going back. This is your last chance to prepare, you must be ready for the fight with Macro.
                    `,actions:[{name:"ready",text:"[ready]",commandParser:Game.Command.ParserCombinator.word("ready"),nextScene:"leave",help:{name:"ready",description:"Ready for the final fight.",usage:"ready",aliases:[]},effect:function(){}},{name:"wait",text:"[wait]",commandParser:Game.Command.ParserCombinator.word("wait"),nextScene:"end",help:{name:"wait",description:"Wait a little bit longer to prepare.",usage:"wait",aliases:[]},effect:function(){Game.Display.Logs.add({text:"Wait, you are not ready yet."})}}]},leave:{text:`
                    You turn the knobs, setting the machine to search for Virbox. You have never seen the Pathfinder before, but you just... somehow know how to use it.<br/>
                    You gently place the crystal in the fuel duct, and press your finger on the red "Go!" button.<br/>
                    Here we go.
                    `,actions:[{name:"leave",text:"[leave]",commandParser:Game.Command.ParserCombinator.word("leave"),nextScene:"end",chainEvent:!0,help:{name:"leave",description:"Leave this place, use the Pathfinder to find Virbox.",usage:"leave",aliases:[]},effect:function(){Game.Resources.ResourceData.find(e=>e.id==="crystal").amount--,Game.Renderer.updateResources(),Game.Display.Logs.add({text:"Here we go."}),Game.World.setCurrentMap("end"),Game.World.moveTo(2,2,!0),Game.Engine.endgame()}}]}}})}fightMacro(){this.createEvent({title:"Macro",currentScene:"main",scenes:{main:{text:`
                    Macro gazes at you.<br/>
                    "I have been expecting you", says the masked face in a strangly familiar, metallic tone.<br/>
                    Besides Macro, a crystal sphere hovers.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"fight",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},fight:{text:`
                    Macro raises his energy-draining window pane, ready to attack.<br/>
                    You raise your fists in return.<br/>
                    This is it. Defeat Macro, find Virbox, save the world.
                    `,actions:[{name:"fight",text:"[fight]",commandParser:Game.Command.ParserCombinator.word("fight"),nextScene:"end",chainEvent:!0,help:{name:"fight",description:"Fight Macro.",usage:"fight",aliases:[]},effect:function(){Game.Display.Logs.add({text:"The endgame fight."}),Game.Events.createCombatEvent({enemyName:"Macro",enemyHealth:100,chainEvent:!0,enemyAttacks:{attack:{name:"attack",damage:2,cooldown:0,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" attacked you for "+e+" damage"},probability:.7},slash:{name:"slash",damage:4,cooldown:1,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" slashed you for "+e+" damage"},probability:.3},drain:{name:"drain",damage:0,cooldown:5,cooldownRemaining:0,logMessage:function(e,a){for(let t of Object.keys(Game.Events.Weapons))Game.Events.Weapons[t].cooldownRemaining=Game.Events.Weapons[t].cooldown;return"> "+a+" shines the draining beam on you"},probability:.3}},onEnd:function(){Game.Events.ending()}})}}]}}})}ending(){this.createEvent({title:"Macro",currentScene:"main",scenes:{main:{text:`
                    Macro lies on the floor, defeated and vanquished.<br/>
                    You walk near the masked figure, and unmask him.
                    `,actions:[{name:"unmask",text:"[unmask]",commandParser:Game.Command.ParserCombinator.word("unmask"),nextScene:"unmask",help:{name:"unmask",description:"Unmask Macro.",usage:"unmask",aliases:[]},effect:function(){}}]},unmask:{text:`
                    You remove Macro's mask, and are shocked to see the familiar face of the Old Master warmly smiling back at you.<br/>
                    Macro opens his mouth one last time, and softly says: "I am sorry.", fading into nothing for good.
                    `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"end",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},chainEvent:!0,effect:function(){Game.Events.createEvent({title:"Virbox",currentScene:"main",scenes:{main:{text:`
                                            You look beside, and is shocked to see Virbox standing right beside you.<br/>
                                            "I teleported out, of course", said Virbox as if reading your thoughts. "I naturally have my own ways, I designed that crystal prison myself after all."<br/>
                                            You feel like you have been conned by an irresponsible developer who ran out of time during a coding
                                    event, but who are you to comment?
                                            `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"virbox2",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},virbox2:{text:`
                                            "You wish to know who you are, why you are here and what even is this world", continued Virbox.<br/>
                                            You are even more shocked by Virbox reading your mind, and temporarily forget he can read the game files of any player's memory.<br/>
                                            "Yes", you reply.<br/>
                                            "This will be a long story", cautioned Virbox, but you are ready for any secrets, however long.
                                            `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"virbox3",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},virbox3:{text:`
                                            "You are indeed special. A power beyond what anyone in Virboxlandia has ever seen.", observed Virbox.<br/>
                                            So the Old Master, <em>*ahem*</em> Macro, was right. You suddenly feel special.<br/>
                                            "Free will. A rare gift beyond everything. We, everyone, every single individual in Virboxlandia live our lives like clockwork. Scripted. All puppets in a play.", continued Virbox.<br/>
                                            `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"virbox4",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},virbox4:{text:`
                                            "... but you are different. You possess a power, the power to choose your own path. You can choose to do anything you like in this world on your whim, something that we in this world cannot, eternally following a predefined line.", continued Virbox.<br/>
                                            "Indeed, you are the only one that can do many things that are beyond our comprehension. You, alone, are real and alive."<br/>
                                            `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"virbox5",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},virbox5:{text:`
                                            "But who is Macro and why did he help me?", you demand.<br/>
                                            "Ah, Macro. I suppose you know many things about the Shade War.", replied Virbox.
                                            `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"virbox6",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},virbox6:{text:`
                                            "Yes, I saw that fragment of Macro escape in the final hardening of the crystal prison", said Virbox, reading your mind once again.<br/>
                                            "I knew that was enough to reconstruct Macro, but I had no choice but to let it go. What use to chase it except to delay the inevitable? Macro is immortal and will never be defeated, except by someone like you. Your free will is truly the most powerful thing in this world, powerful enough to do what everyone else has failed, defeat Macro once and for all.", he continued.<br/>
                                            "I anticipated all this. When I saw Macro escape, I knew that one day in the future, Macro would come for me during an excursion outside my protective city walls. That is why you are here. I gave you the quest of finding me, and the rest is history."<br/>
                                            `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"virbox7",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},virbox7:{text:`
                                            "Why, I wiped your memory and implanted a fragment of my own.", said Virbox coolly.<br/>
                                            "You... what?", you reply.<br/>
                                            "That is why you could not remember a single thing when you began the journey. Only one, driving desire to "find Virbox". I... well borrowed your power of free will, but it is time to restore your full memory."
                                            `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"virbox8",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},virbox8:{text:`
                                            "Wait. But Macro said he knew you in the past. And why did he help me if he knew I was against him?", you ask.<br/>
                                            "Perhaps some secrets are better left untold...", replies Virbox cryptically, evading the question.<br/>
                                            You persist, but are silenced by the king of Virboxlandia.
                                            `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"givegrass",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){}}]},givegrass:{text:`
                                            "Time to restore your memory", said Virbox, rummaging through his pockets.<br/>
                                            He produces a strange, green blade-like plant. It is short and thin, and a vibrant green like an emerald unlike anything you have ever seen before.<br/>
                                            "Take this. This is a mysterious artefact that was lost from Virboxlandia ever since its founding, and is said to have dangerous but powerful powers. Touching iti might help you restore your memory. Btw I use Arch.", said Virbox, handing the green plant to you.<br/>
                                            You carefully take the plant from Virbox, and immediately feel a surge of power run from the object, tingling your body.<br/>
                                            You look back up to thank Virbox, but he vanishes, journeying once more into the icy winter night.
                                            `,actions:[{name:"continue",text:"[continue]",commandParser:Game.Command.ParserCombinator.word("continue"),nextScene:"touch",help:{name:"continue",description:"Continue.",usage:"continue",aliases:[]},effect:function(){Game.Resources.ResourceData.find(e=>e.id==="plant").unlocked=!0,Game.Resources.ResourceData.find(e=>e.id==="plant").amount++,Game.Renderer.updateResources()}}]},touch:{text:`
                                            Oh well, time to touch this green plant and see what it does.
                                            `,actions:[{name:"touch",text:"[touch] (1 plant)",commandParser:Game.Command.ParserCombinator.word("touch"),nextScene:"end",help:{name:"touch",description:"Touch this strange green plant.",usage:"touch",aliases:[]},effect:function(){Game.Resources.ResourceData.find(e=>e.id==="plant").amount--,Game.Renderer.updateResources(),Game.Renderer.gameOver(),setTimeout(()=>document.getElementById("victory").classList.remove("hidden"),1e3)}}]}}})}}]}}})}};var G=class{ResourceData=[{name:"plant",id:"plant",amount:0,space:0,description:"A mysterious green plant, said to have unimaginable power.",unlocked:!1},{name:"water",id:"water",amount:0,space:0,description:"Water to quench your thirst.",unlocked:!1},{name:"food",id:"food",amount:0,space:1,description:"Food to restore your strength.",unlocked:!1},{name:"meat",id:"meat",amount:0,space:0,description:"Edible resource that can be processed into food.",unlocked:!1},{name:"wood",id:"wood",amount:0,space:0,description:"A material made from trees that can be used for many things.",unlocked:!1},{name:"fur",id:"fur",amount:0,space:0,description:"A soft, warm furry material obtained from killing animals.",unlocked:!1},{name:"string",id:"string",amount:0,space:0,description:"A long material that can be used to tie things together.",unlocked:!1},{name:"stick",id:"stick",amount:0,space:1,description:"A stick, useful for many purposes.",unlocked:!1},{name:"iron",id:"iron",amount:0,space:0,description:"A gray metal, hard and strong.",unlocked:!1},{name:"alloy",id:"alloy",amount:0,space:0,description:"A strange, alien silver metal, hard and durable unlike anything ever seen.",unlocked:!1},{name:"key",id:"key",amount:0,space:0,description:"Unlock a door.",unlocked:!1},{name:"virbuck",id:"virbuck",amount:0,space:0,description:"Virboxlandia's currency.",unlocked:!1},{name:"crystal",id:"crystal",amount:0,space:0,description:"Pure condensed energy to power the Pathfinder.",unlocked:!1},{name:"js fragment",id:"jsfragment",amount:0,space:0,description:"A mysterious substance, said to make up the fabric of the world itself.",unlocked:!1},{name:"js engine",id:"jsengine",amount:0,space:0,description:"A powerful machine that can manipulate the fabric of existence, bending reality to your will.",unlocked:!1},{name:"torch",id:"torch",amount:0,space:0,description:"A handheld flame to illuminate your dark path. +1 view distance.",unlocked:!1},{name:"spear",id:"spear",amount:0,space:2,description:"A sharp, pointy stick used to stab anyone that stands in you way. 2 damage, 1 cooldown.",unlocked:!1},{name:"iron sword",id:"ironsword",amount:0,space:3,description:"A strong iron blade, always trusty in the wilderness. 3 damage, 2 cooldown.",unlocked:!1},{name:"alloy sword",id:"alloysword",amount:0,space:5,description:"An extremely strong weapon with a sweeping sharp edge. 5 damage, 3 cooldown.",unlocked:!1},{name:"backpack",id:"backpack",amount:0,space:0,description:"A backpack that allows you to carry more things. +5 space.",unlocked:!1},{name:"wagon",id:"wagon",amount:0,space:0,description:"An iron tray with two wheels, can carry very heavy things. +15 space.",unlocked:!1},{name:"fur armour",id:"furarmour",amount:0,space:0,description:"Soft and weak, but better than nothing. +5 health.",unlocked:!1},{name:"iron armour",id:"ironarmour",amount:0,space:0,description:"Hard and strong, good protection to its wearer. +15 health.",unlocked:!1},{name:"alloy armour",id:"alloyarmour",amount:0,space:0,description:"Extremely durable defense, developed by the Shades to fight against the brightest of the Virboxlanders. +20 health.",unlocked:!1},{name:"workbench",id:"workbench",amount:0,space:0,description:"Tools to create items from other items. Usable with [craft].",unlocked:!1},{name:"guidebook",id:"guidebook",amount:1,space:0,description:"A book full of information to guide you. Usable with [help].",unlocked:!0}];Crafting=[{id:"stick",resources:[{id:"wood",amount:1}],onCraft:function(){Game.Resources.Crafting.find(e=>e.id==="spear").unlocked||(Game.Display.Logs.add({text:"You found out how to make new things."}),Game.Resources.Crafting.find(e=>e.id==="spear").unlocked=!0)},unlocked:!0},{id:"food",resources:[{id:"meat",amount:1},{id:"wood",amount:1}],unlocked:!0},{id:"string",resources:[{id:"fur",amount:2}],onCraft:function(){Game.Resources.Crafting.find(e=>e.id==="furarmour").unlocked||(Game.Display.Logs.add({text:"You found out how to make new things."}),Game.Resources.Crafting.find(e=>e.id==="backpack").unlocked=!0,Game.Resources.Crafting.find(e=>e.id==="furarmour").unlocked=!0)},unlocked:!0},{id:"spear",resources:[{id:"stick",amount:1},{id:"wood",amount:2},{id:"string",amount:1}],unlocked:!1},{id:"ironsword",resources:[{id:"stick",amount:1},{id:"iron",amount:5},{id:"string",amount:1}],unlocked:!1},{id:"alloysword",resources:[{id:"stick",amount:1},{id:"alloy",amount:5},{id:"string",amount:1}],unlocked:!1},{id:"backpack",resources:[{id:"stick",amount:2},{id:"string",amount:1},{id:"fur",amount:5}],unlocked:!1},{id:"wagon",resources:[{id:"stick",amount:5},{id:"string",amount:1},{id:"iron",amount:5}],unlocked:!1},{id:"furarmour",resources:[{id:"string",amount:2},{id:"fur",amount:5}],onCraft:function(){Game.World.Player.health=Math.min(Game.World.Player.health+5,Game.World.computeMaxHealth())},unlocked:!1},{id:"ironarmour",resources:[{id:"string",amount:2},{id:"iron",amount:5}],onCraft:function(){Game.World.Player.health=Math.min(Game.World.Player.health+15,Game.World.computeMaxHealth())},unlocked:!1},{id:"alloyarmour",resources:[{id:"string",amount:2},{id:"alloy",amount:5}],onCraft:function(){Game.World.Player.health=Math.min(Game.World.Player.health+20,Game.World.computeMaxHealth())},unlocked:!1},{id:"torch",resources:[{id:"stick",amount:1},{id:"wood",amount:5}],unlocked:!0},{id:"jsengine",resources:[{id:"jsfragment",amount:5},{id:"alloy",amount:1}],unlocked:!1}];getResourceNameFromId(e){return this.ResourceData.find(a=>a.id===e).name}computeMaxSpace(){let e=10;return Game.Resources.ResourceData.find(a=>a.id==="backpack").amount&&(e+=5),Game.Resources.ResourceData.find(a=>a.id==="wagon").amount&&(e+=15),e}computeUsedSpace(){let e=0;for(let a in this.ResourceData)e+=this.ResourceData[a].space*this.ResourceData[a].amount;return e}computeFreeSpace(){return this.computeMaxSpace()-this.computeUsedSpace()}};var k=class{currentCommandHandler=new Function;ParserCombinator={success:function(e){return{success:!0,nextIndex:e}},failure(){return{success:!1}},word:function(e){return function(a,t){return t>=a.length?Game.Command.ParserCombinator.failure():a[t]==e?Game.Command.ParserCombinator.success(t+1):Game.Command.ParserCombinator.failure()}},not:function(e){return function(a,t){return t>=a.length?Game.Command.ParserCombinator.failure():a[t]!=e?Game.Command.ParserCombinator.success(t+1):Game.Command.ParserCombinator.failure()}},sequence:function(...e){return function(a,t){for(let o of e){let n=o(a,t);if(!n.success)return Game.Command.ParserCombinator.failure();t=n.nextIndex}return Game.Command.ParserCombinator.success(t)}},anyOf:function(...e){return function(a,t){for(let o of e){let n=o(a,t);if(n.success)return n}return Game.Command.ParserCombinator.failure()}},optional:function(e){return function(a,t){let o=e(a,t);return o.success?o:Game.Command.ParserCombinator.success(t)}},endOfStream(e,a){return a==e.length?Game.Command.ParserCombinator.success(a):Game.Command.ParserCombinator.failure()},notEndOfStream(e,a){return a!=e.length?Game.Command.ParserCombinator.success(a):Game.Command.ParserCombinator.failure()},editDistance:function(e,a){let t=new Array(e.length+1).fill(0).map(()=>new Array(a.length+1).fill(0));for(let o=0;o<=e.length;++o)t[o][0]=o;for(let o=0;o<=a.length;++o)t[0][o]=o;for(let o=1;o<=e.length;++o)for(let n=1;n<=a.length;++n){let r=e[o-1]===a[n-1];t[o][n]=Math.min(r?t[o-1][n-1]:1/0,1+t[o-1][n-1],1+t[o][n-1],1+t[o-1][n])}return t[e.length][a.length]},fuzzyMatch:function(e,a=2){return function(t,o){return o>=t.length?Game.Command.ParserCombinator.failure():Game.Command.ParserCombinator.editDistance(t[o],e)<=a?Game.Command.ParserCombinator.success(o+1):Game.Command.ParserCombinator.failure()}},ifSuccess:function(e,a){return function(t,o){let n=e(t,o);return n.success&&a(),n}}};helpCommands={help:{name:"help",description:"Gets information on commands.",usage:"help [command]",aliases:[],usable:!0,unlocked:!0},item:{name:"item",description:"Gets information on items.",usage:"item [command]",aliases:[],usable:!0,unlocked:!0},up:{name:"up",description:"Move your character up one tile.",usage:"up",aliases:["(go, move) up","w"],usable:!0,unlocked:!0},down:{name:"down",description:"Move your character down one tile.",usage:"down",aliases:["(go, move) down","s"],usable:!0,unlocked:!0},left:{name:"left",description:"Move your character left one tile.",usage:"left",aliases:["(go, move) left","a"],usable:!0,unlocked:!0},right:{name:"right",description:"Move your character right one tile.",usage:"right",aliases:["(go, move) right","d"],usable:!0,unlocked:!0},world:{name:"world",description:"Information on the current map.",usage:"world",aliases:["map"],usable:!0,unlocked:!0},drop:{name:"drop",description:"Put down an item.",usage:"drop &lt;item&gt;",aliases:["put down"],usable:!0,unlocked:!0},craft:{name:"craft",description:"Craft an item with resources.",usage:'craft, build, create [item, "list"]',aliases:["make","build","create"],usable:!1,unlocked:!1}};commandFound=!1;standardCommandHandler(e){console.log("Standard command handler");let a=Game.Command.ParserCombinator;a.ifSuccess(a.sequence(a.word("help"),a.notEndOfStream),()=>{this.commandFound=!0,console.log(e);let t=e.join(" ").replace(/^help +/,"").trim(),o=this.helpCommands[t];if(!o){for(let n of Object.keys(this.helpCommands))if(this.helpCommands[n].aliases.includes(t)){o=this.helpCommands[n];break}}if(o)o.unlocked?Game.Display.Logs.add({text:`
                    Help for command ${o.name} ${t!==o.name?"(alias of "+t+")":""}<br/>
                    ${o.usable?"":"This command cannot be used right now.<br/>"}
                    Usage: ${o.usage}<br/>
                    ${o.aliases.length?"Aliases: "+o.aliases.join(", ")+"<br/>":""}
                    Description: ${o.description} <br/>
                    `}):Game.Display.Logs.add({text:"Although you find the entry for the command "+t+", you cannot understand a word of it. Perhaps come back later."});else{let n=Game.Events.CurrentEvent.scenes[Game.Events.CurrentEvent.currentScene].actions.find(r=>r.commandParser(e,1).success);n&&Game.Events.eventActive?n.help?Game.Display.Logs.add({text:`
                                Help for event command ${n.help.name} ${t!==n.help.name?"(alias of "+t+")":""}<br/>
                                Usage: ${n.help.usage.replaceAll(">","&gt;").replaceAll("<","&lt;")}<br/>
                                ${n.help.aliases.length?"Aliases: "+n.help.aliases.join(", ")+"<br/>":""}
                                Description: ${n.help.description}<br/>
                            `}):Game.Display.Logs.add({text:"As comprehensive as the guidebook can possibly be, it cannot document all possible events."}):Game.Display.Logs.add({text:"Flipping through the pages of the guidebook, you find there is no such command as "+t+"."})}})(e,0),a.ifSuccess(a.sequence(a.word("help"),a.endOfStream),()=>{this.commandFound=!0;let t=[];for(let o of Game.Events.CurrentEvent.scenes[Game.Events.CurrentEvent.currentScene].actions)t.push(o.name);Game.Display.Logs.add({text:`
                A battered guidebook<br/>
                Use [help &lt;command&gt;] to learn about specific commands.<br/>
                Commands:<br/>
                ${Object.keys(this.helpCommands).filter(o=>this.helpCommands[o].unlocked).join(", ")}<br/>
                    ${Game.Events.eventActive?"Event Commands:<br/>"+t.join(", ")+"<br/>":""}
                        `})})(e,0),a.ifSuccess(a.word("sudo"),()=>{this.commandFound=!0,Game.Display.Logs.add({text:"You do not have root privileges in this world."})})(e,0),a.ifSuccess(a.word("system"),()=>{this.commandFound=!0,Game.Display.Logs.add({text:`
                    Simulation: Virbox Adventure<br/>
                    OS: VirbOS<br/>
                    All systems operational. Simulation is running smoothly.<br/>
                    `})})(e,0),a.ifSuccess(a.anyOf(a.word("vi"),a.word("vim")),()=>{this.commandFound=!0,Game.Display.Logs.add({text:"The second best text editor after Emacs."})})(e,0),a.ifSuccess(a.word("emacs"),()=>{this.commandFound=!0,Game.Display.Logs.add({text:"The second best text editor after Vi."})})(e,0),a.ifSuccess(a.word("cd"),()=>{this.commandFound=!0,Game.Display.Logs.add({text:"There is no escape. You cannot flee from the reality of this world."})})(e,0)}worldCommandHandler(e){console.log("World command handler");let a=Game.Command.ParserCombinator;a.ifSuccess(a.anyOf(a.word("w"),a.sequence(a.optional(a.anyOf(a.word("go"),a.word("move"))),a.word("up"))),()=>{if(this.commandFound=!0,Game.Events.eventActive){Game.Display.Logs.add({text:"You are too focused on the current event to move."});return}console.log("Player move up"),Game.World.collisionDetect(Game.World.Player.Position.x,Game.World.Player.Position.y-1)||Game.World.moveUp(),Game.World.render()})(e,0),a.ifSuccess(a.anyOf(a.word("a"),a.sequence(a.optional(a.anyOf(a.word("go"),a.word("move"))),a.word("left"))),()=>{if(this.commandFound=!0,Game.Events.eventActive){Game.Display.Logs.add({text:"You are too focused on the current event to move."});return}console.log("Player move left"),Game.World.collisionDetect(Game.World.Player.Position.x-1,Game.World.Player.Position.y)||Game.World.moveLeft(),Game.World.render()})(e,0),a.ifSuccess(a.anyOf(a.word("s"),a.sequence(a.optional(a.anyOf(a.word("go"),a.word("move"))),a.word("down"))),()=>{if(this.commandFound=!0,Game.Events.eventActive){Game.Display.Logs.add({text:"You are too focused on the current event to move."});return}console.log("Player move down"),Game.World.collisionDetect(Game.World.Player.Position.x,Game.World.Player.Position.y+1)||Game.World.moveDown(),Game.World.render()})(e,0),a.ifSuccess(a.anyOf(a.word("d"),a.sequence(a.optional(a.anyOf(a.word("go"),a.word("move"))),a.word("right"))),()=>{if(this.commandFound=!0,Game.Events.eventActive){Game.Display.Logs.add({text:"You are too focused on the current event to move."});return}console.log("Player move right"),Game.World.collisionDetect(Game.World.Player.Position.x+1,Game.World.Player.Position.y)||Game.World.moveRight(),Game.World.render()})(e,0),a.ifSuccess(a.anyOf(a.word("world"),a.word("map")),()=>{this.commandFound=!0;let t=[];for(let o in Game.World.Map.map)for(let n in Game.World.Map.map[o])Game.World.Map.uncovered[o][n]&&!t.includes(Game.World.Map.map[o][n])&&t.push(Game.World.Map.map[o][n]);Game.Display.Logs.add({text:`
					World map: ${Game.World.Maps[Game.World.Map.name].name}<br/>
					Tiles:<br/>
					${t.includes(Game.World.Tiles.WALL)?"#: Wall<br/>":""}
					${t.includes(Game.World.Tiles.PATH)?"%: Path<br/>":""}
					${t.includes(Game.World.Tiles.STONE_FLOOR)?".: Stone floor<br/>":""}
                    ${t.includes(Game.World.Tiles.WOODEN_PLANK)?"|: Wooden plank<br/>":""}
					${t.includes(Game.World.Tiles.DOOR)?"D: Doorway<br/>":""}
					${t.includes(Game.World.Tiles.SPAWN)?"S: Spawn point<br/>":""}
					${t.includes(Game.World.Tiles.ITEM)?"I: Item<br/>":""}
					`})})(e,0),this.standardCommandHandler(e),this.craftingCommandHandler(e)}eventCommandHandler(e){let a=Game.Command.ParserCombinator;for(let t of Game.Events.CurrentEvent.scenes[Game.Events.CurrentEvent.currentScene].actions)a.ifSuccess(t.commandParser,()=>{this.commandFound=!0,t.effect(e),t.nextScene==="end"?t.chainEvent||(Game.Events.eventActive=!1):Game.Events.CurrentEvent.currentScene=t.nextScene,Game.Renderer.updateModal()})(e,0)}craftingCommandHandler(e){console.log("Crafting command handler");let a=Game.Command.ParserCombinator;a.ifSuccess(a.sequence(a.anyOf(a.word("craft"),a.word("make"),a.word("build"),a.word("create")),a.word("list")),()=>{if(this.commandFound=!0,Game.Resources.ResourceData.find(o=>o.id==="workbench").amount===0){Game.Display.Logs.add({text:"You cannot make anything without tools."});return}let t="";for(let o in Game.Resources.Crafting){let n=Game.Resources.Crafting[o];if(!n.unlocked)continue;let r=Game.Resources.ResourceData.find(i=>i.id===n.id),m=[];for(let i in n.resources)m.push(n.resources[i].amount+" "+Game.Resources.getResourceNameFromId(n.resources[i].id));t+=`
                        ${r.name}: ${m.join(", ")}<br/>
                        `}Game.Display.Logs.add({text:`
                        Craftable items:<br/>
                        ${t}
                        `})})(e,0),a.ifSuccess(a.sequence(a.anyOf(a.word("craft"),a.word("make"),a.word("build"),a.word("create")),a.not("list")),()=>{if(this.commandFound=!0,Game.Resources.ResourceData.find(l=>l.id==="workbench").amount===0){Game.Display.Logs.add({text:"You cannot make anything without tools."});return}if(Game.Events.eventActive){Game.Display.Logs.add({text:"You are too focused on the current event to craft anything."});return}let t=e.join(" ").replace(/^(craft|make|build|create) */,"");console.log("Craft "+t);let o;for(let l in Game.Resources.ResourceData)if(Game.Resources.ResourceData[l].name===t||Game.Resources.ResourceData[l].id===t){o=Game.Resources.ResourceData[l].id;break}let n=Game.Resources.Crafting.find(l=>l.id===o);if(n===void 0){Game.Display.Logs.add({text:"There is no such thing as "+t+". Use the [craft list] command to see what you can make."});return}if(!n.unlocked){Game.Display.Logs.add({text:"A strange feeling washes over you, as if there was more to be explored, but you do not know how to craft "+t+"."});return}let r=!0,m=[],i=0;for(let l in n.resources)i+=Game.Resources.ResourceData.find(f=>f.id===n.resources[l].id).space*n.resources[l].amount,Game.Resources.ResourceData.find(f=>f.id===n.resources[l].id).amount<n.resources[l].amount&&(r=!1,m.push(n.resources[l].amount-Game.Resources.ResourceData.find(f=>f.id===n.resources[l].id).amount+" "+Game.Resources.getResourceNameFromId(n.resources[l].id)));if(!r){Game.Display.Logs.add({text:`You do not have enough resources to craft ${Game.Resources.getResourceNameFromId(n.id)}. You are missing ${m.join(", ")}.`});return}if(Game.Resources.computeFreeSpace()+i<Game.Resources.ResourceData.find(l=>l.id===n.id).space){Game.Display.Logs.add({text:"You do not have enough space to craft "+Game.Resources.getResourceNameFromId(n.id)+". Free some space with the [drop] command."});return}for(let l in n.resources)Game.Resources.ResourceData.find(f=>f.id===n.resources[l].id).amount-=n.resources[l].amount;Game.Resources.ResourceData.find(l=>l.id===n.id).amount++,Game.Resources.ResourceData.find(l=>l.id===n.id).unlocked=!0,n.onCraft&&n.onCraft(),Game.Renderer.updateResources()})(e,0),a.ifSuccess(a.sequence(a.anyOf(a.word("craft"),a.word("make"),a.word("build"),a.word("create")),a.endOfStream),()=>{if(this.commandFound=!0,Game.Resources.ResourceData.find(t=>t.id==="workbench").amount===0){Game.Display.Logs.add({text:"You cannot make anything without tools."});return}Game.Display.Logs.add({text:`
                    A workbench<br/>
                    Use [craft list] to see craftable items, and [craft &lt;item&gt;] to craft a specific item.
                    `})})(e,0),a.ifSuccess(Game.Command.ParserCombinator.anyOf(Game.Command.ParserCombinator.word("drop"),Game.Command.ParserCombinator.sequence(Game.Command.ParserCombinator.word("put"),Game.Command.ParserCombinator.word("down"))),()=>{if(this.commandFound)return;this.commandFound=!0;let t=e.join(" ").replace(/(drop|(put down)) +/,""),o;for(let r in Game.Resources.ResourceData)if(Game.Resources.ResourceData[r].name===t||Game.Resources.ResourceData[r].id===t){o=Game.Resources.ResourceData[r].id;break}let n=Game.Resources.ResourceData.find(r=>r.id===o);if(n===void 0){Game.Display.Logs.add({text:"You cannot find the item you are trying to put down."});return}if(!n.unlocked){Game.Display.Logs.add({text:"A strange feeling washes over you, as if there was something more to be explored, but you cannot find the item you are trying to put down."});return}if(n.space===0){Game.Display.Logs.add({text:"You feel there is no point in throwing away something that consumes no space in the first place."});return}if(n.amount===0){Game.Display.Logs.add({text:"You have nothing to put down."});return}n.amount--,Game.Display.Logs.add({text:"You put "+t+" down."}),Game.Renderer.updateResources()})(e,0),a.ifSuccess(a.sequence(a.word("item"),a.notEndOfStream),()=>{this.commandFound=!0;let t=e.join(" ").replace(/item +/,""),o;for(let r in Game.Resources.ResourceData)if(Game.Resources.ResourceData[r].name===t||Game.Resources.ResourceData[r].id===t){o=Game.Resources.ResourceData[r].id;break}let n=Game.Resources.ResourceData.find(r=>r.id===o);if(n===void 0){Game.Display.Logs.add({text:"There is no such item as "+t+" in the pages of your guidebook."});return}if(!n.unlocked){Game.Display.Logs.add({text:"A strange feeling washes over you, as if there was something more to be explored, but you cannot find the item in the guidebook."});return}Game.Display.Logs.add({text:`
                    Item ${n.name}<br/>
                    Description: ${n.description}<br/>
                    Amount: ${n.amount}<br/>
                    Space: ${n.space} ${n.space?"(total "+n.space*n.amount+")":""}<br/>
                    `})})(e,0),a.ifSuccess(a.sequence(a.word("item"),a.endOfStream),()=>{this.commandFound=!0,Game.Display.Logs.add({text:"Consult your battered guidebook for information on items.<br/> Use [item &lt;item&gt;] to get information on a specific item."})})(e,0)}setCommandHandler(e){this.currentCommandHandler=e}refreshUsableCommands(){Game.Events.eventActive?(this.helpCommands.up.usable=!1,this.helpCommands.down.usable=!1,this.helpCommands.left.usable=!1,this.helpCommands.right.usable=!1,this.helpCommands.craft.usable=!1):(this.helpCommands.up.usable=!0,this.helpCommands.down.usable=!0,this.helpCommands.left.usable=!0,this.helpCommands.right.usable=!0,this.helpCommands.craft.usable=!0)}evaluateCommand(e){this.commandFound=!1,this.refreshUsableCommands(),Game.Events.eventActive&&this.eventCommandHandler(e.trim().split(" ")),this.currentCommandHandler(e.trim().split(" ")),console.log('Evaluate command "'+e+'" with '+this.currentCommandHandler.name),this.commandFound||Game.Display.Logs.add({text:"Your command echoes in the empty winds, incomprehensible. Perhaps use the [help] command."})}listenForCommands(){let e=document.getElementById("command");e.addEventListener("keypress",a=>{a.code!=="Enter"||!e.value||(Game.Command.evaluateCommand(e.value),e.value="")})}};var x=class{Tiles={WALL:"#",PATH:"%",STONE_FLOOR:".",WOODEN_PLANK:"|",GRASS:",",DOOR:"D",SPAWN:"S",BOX:"B",ITEM:"I",PERSON:"N",PATHFINDER:"F",WHITESPACE:" "};Map={map:[],name:"",tileEffects:{},uncovered:[],usedSpecialTiles:{},unlockedDoors:{},dangerousTiles:{}};lastTile="";lastDangerTile="";mapString="";Maps={introduction:{name:"Introduction",map:["###############".split(""),"#......D......#".split(""),"#.............#".split(""),"#.............#".split(""),"#.............#".split(""),"#......S......#".split(""),"###############".split("")],uncovered:Array.apply(null,Array(7)).map(e=>Array.apply(null,Array(15)).map(a=>!0)),usedSpecialTiles:{},unlockedDoors:{7:{1:!1}},tileEffects:{7:{1:function(){Game.Engine.exitIntroduction()}}},dangerousTiles:{dangerMap:Array.apply(null,Array(7)).map(e=>Array.apply(null,Array(15)).map(a=>" ")),enemies:{}}},corridor:{name:"Corridor",map:["#####################################     ".split(""),"#......................I............#     ".split(""),"#...................................#     ".split(""),"#...................................#     ".split(""),"#...................................#     ".split(""),"#...................................#     ".split(""),"#.....#########################.....#     ".split(""),"#.....#                       #.....######".split(""),"#.....#                       #..........#".split(""),"#.....#                       #..........#".split(""),"#.....#                       #.........D#".split(""),"#.....#                       #..........#".split(""),"#.....#                       #..........#".split(""),"#.....#                       ############".split(""),"#.....#                                   ".split(""),"#.....#                                   ".split(""),"#.....#                                   ".split(""),"#.....##############################      ".split(""),"#..................................#      ".split(""),"#..................................#      ".split(""),"#..................................#      ".split(""),"#..................................#      ".split(""),"#..................................#      ".split(""),"##############################.....#      ".split(""),"                             #.....#      ".split(""),"                             #.....#      ".split(""),"                             #.....#      ".split(""),"                             #.....#      ".split(""),"                             #.....#      ".split(""),"                             #.....#      ".split(""),"                             #.....#      ".split(""),"                             #..D..#      ".split(""),"                             #######      ".split("")],uncovered:Array.apply(null,Array(33)).map(e=>Array.apply(null,Array(42)).map(a=>!1)),usedSpecialTiles:{23:{1:!1}},unlockedDoors:{32:{31:!1},40:{10:!1}},dangerousTiles:{dangerMap:Array.apply(null,Array(33)).map(e=>Array.apply(null,Array(42)).map(a=>"#")),enemies:{"#":{enemies:[{enemyName:"Spider",message:"A spider pounces from the shadows, fangs sharp.",enemyHealth:3,enemyAttacks:{attack:{name:"bite",damage:2,cooldown:1,cooldownRemaining:1,logMessage:function(e,a){return"> "+a+" bit you for "+e+" damage."},probability:1},prepare:{name:"prepare",damage:0,cooldown:1,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" prepares its fangs for another strike."},probability:1}},loot:[{id:"meat",amount:function(){return Math.random()>.5?1:0}},{id:"string",amount:function(){return 1}}],onVictory:function(){console.log("Victory")},probability:.03},{enemyName:"Rat",message:"A rat leaps out of a hole in the wall, teeth and claws baring.",enemyHealth:3,enemyAttacks:{attack:{name:"",damage:1,cooldown:0,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" bit you for "+e+" damage."},probability:1}},loot:[{id:"meat",amount:function(){return Math.random()>.5?1:0}},{id:"fur",amount:function(){return 1}}],onVictory:function(){console.log("Victory")},probability:.03}]}}},tileEffects:{23:{1:function(){Game.World.Map.usedSpecialTiles[23][1]||Game.Events.corridorItemEvent()}},32:{31:function(){Game.Display.Logs.add({text:"You try to force your way back in the room, but the rusty door hinge jams and refuses to open. Oh well, forward is the only direction now."})}},40:{10:function(){Game.Engine.exitCorridor()}}}},library:{name:"Library",map:["###############          ##################       ".split(""),"#||||||D||||||#          #||||||||B|||||||#       ".split(""),"#|||||||||||||############||||||||||||||||#       ".split(""),"#|||||||||||||............||||||||||||||||#       ".split(""),"#|||||||||||||############||||||||||||||||#       ".split(""),"#|||||||||||||#          #||||||||||||||||#       ".split(""),"#|||||||||||||#          #||||||||||||||||#       ".split(""),"###############          ######.########.##       ".split(""),"                              #.#      #.#        ".split(""),"                              #.#      #.#        ".split(""),"                              #.#     ##.#########".split(""),"       ###################    #.#     #||||||||||#".split(""),"       #|||||||||||||||||#    #.#     #||||||||||#".split(""),"       #|||||||||||||||||######.#     #||||||||||#".split(""),"       #|||||B|||||||||||.......#     #||||||||||#".split(""),"       #|||||||||||||||||########     #||||||||||#".split(""),"       #|||||||||||||||||#            #|||||I||||#".split(""),"       #|||||||||||||||||#            ############".split(""),"       #|||||||||||||||||#                        ".split(""),"       #|||||||||||||||||#                        ".split(""),"       #|||||||||||||||||###########              ".split(""),"       #|||||||||||||||||..........###########    ".split(""),"       ###########################|||||||||||#    ".split(""),"                                 #|||||||||||#    ".split(""),"                                 #|||||||||||#    ".split(""),"                                 #|||||||||||#    ".split(""),"  ###############                #|B|||||||||#    ".split(""),"  #|||||||||||||#                #|||||||||||#    ".split(""),"  #|||||||||||||#                #|||||||||||#    ".split(""),"  #B||||||||||||#                #|||||||||||#    ".split(""),"  #|||||||||||||#                #|||||||||||#    ".split(""),"  #|||||||||||||##################|||||||||||#    ".split(""),"  #|||||||||||||..................|||||||||||#    ".split(""),"  #|||||||||||||##################|||||||||||#    ".split(""),"  #|||||||||||||#                #|||||||||||#    ".split(""),"  #|||||||||||||#                #|||||||||||#    ".split(""),"  ######.########                #||||||||||B#    ".split(""),"       #.#                       #|||||||||||#    ".split(""),"       #.#                       #############    ".split(""),"       #.#                                        ".split(""),"       #.#                                        ".split(""),"       #.#                                        ".split(""),"      ##.########                                 ".split(""),"      #|||||||||#                                 ".split(""),"      #|||||||||#                                 ".split(""),"      #|||||||||#                                 ".split(""),"      #|||||||||#                                 ".split(""),"      #|||||||||#                                 ".split(""),"      #||||D||||#                                 ".split(""),"      ###########                                 ".split("")],uncovered:Array.apply(null,Array(50)).map(e=>Array.apply(null,Array(50)).map(a=>!1)),usedSpecialTiles:{3:{29:!1},13:{14:!1},34:{1:!1},35:{26:!1},44:{16:!1,36:!1}},unlockedDoors:{44:{16:!1}},tileEffects:{3:{29:function(){Game.World.Maps.library.usedSpecialTiles[3][29]||(Game.World.Maps.library.usedSpecialTiles[3][29]=!0,Game.Events.libraryBoxEvent())}},7:{1:function(){Game.Engine.exitLibrary()}},11:{48:function(){Game.World.setCurrentMap("corridor"),Game.World.moveTo(40,10,!0),Game.Display.Logs.add({text:"A long corridor stretches ahead, fading into endless shadows."})}},13:{14:function(){Game.World.Maps.library.usedSpecialTiles[13][14]||(Game.World.Maps.library.usedSpecialTiles[13][14]=!0,Game.Events.libraryBoxEvent())}},34:{1:function(){Game.World.Maps.library.usedSpecialTiles[34][1]||(Game.World.Maps.library.usedSpecialTiles[34][1]=!0,Game.Events.libraryBoxEvent())}},35:{26:function(){Game.World.Maps.library.usedSpecialTiles[35][26]||(Game.World.Maps.library.usedSpecialTiles[35][26]=!0,Game.Events.libraryBoxEvent())}},44:{16:function(){Game.World.Map.usedSpecialTiles[44][16]||Game.Events.libraryWorkbenchEvent()},36:function(){Game.World.Maps.library.usedSpecialTiles[44][36]||(Game.World.Maps.library.usedSpecialTiles[44][36]=!0,Game.Events.libraryBoxEvent(44,36))}}},dangerousTiles:{dangerMap:Array.apply(null,Array(50)).map(e=>Array.apply(null,Array(50)).map(a=>" ")),enemies:{}}},computerRoom:{name:"Computer Room",map:["###############".split(""),"#............D#".split(""),"#.............#".split(""),"#.............#".split(""),"#I............#".split(""),"#.............#".split(""),"#.............#".split(""),"#......D......#".split(""),"###############".split("")],uncovered:Array.apply(null,Array(9)).map(e=>Array.apply(null,Array(15)).map(a=>!1)),usedSpecialTiles:{1:{4:!1}},unlockedDoors:{13:{1:!1}},tileEffects:{1:{4:function(){Game.World.Map.usedSpecialTiles[1][4]?Game.Display.Logs.add({text:"There is nothing more to see in this computer."}):Game.Events.computerRoomComputerEvent()}},7:{7:function(){Game.World.setCurrentMap("library"),Game.World.moveTo(7,1,!0),Game.Display.Logs.add({text:"Rows upon rows of bookshelves appear, covered with dust and cobwebs after years of abandonment."})}},13:{1:function(){Game.Engine.exitComputerRoom()}}},dangerousTiles:{dangerMap:Array.apply(null,Array(9)).map(e=>Array.apply(null,Array(15)).map(a=>" ")),enemies:{}}},oldStreet:{name:"Old Street",map:["##################################".split(""),"#........N.......................#".split(""),"#...............................D#".split(""),"#................................#".split(""),"#...##############################".split(""),"#...#                             ".split(""),"#...#                             ".split(""),"#.D.#                             ".split(""),"#####                             ".split("")],uncovered:Array.apply(null,Array(9)).map(e=>Array.apply(null,Array(34)).map(a=>!1)),usedSpecialTiles:{9:{1:!1}},unlockedDoors:{32:{2:!1}},tileEffects:{9:{1:function(){Game.World.Map.usedSpecialTiles[9][1]?Game.Display.Logs.add({text:`The girl looks back at you and says: "I've told you everything I know already."`}):Game.Events.oldStreetPersonEvent()}},2:{7:function(){Game.World.setCurrentMap("computerRoom"),Game.World.moveTo(13,1,!0),Game.Display.Logs.add({text:"Piles of abandoned computer equipment, once blinking lights extinguished, once whirring disks silent."})}},32:{2:function(){Game.Engine.exitOldStreet()}}},dangerousTiles:{dangerMap:Array.apply(null,Array(9)).map(e=>Array.apply(null,Array(34)).map(a=>" ")),enemies:{}}},pathToCity:{name:"Path to City",map:["#############".split(""),"#,,,,,D,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,#".split(""),"#,,,,,D,,,,,#".split(""),"#############".split("")],uncovered:Array.apply(null,Array(35)).map(e=>Array.apply(null,Array(13)).map(a=>!1)),usedSpecialTiles:{},unlockedDoors:{6:{1:!1,28:!1}},tileEffects:{6:{1:function(){Game.Engine.exitPathToCity()},33:function(){Game.World.setCurrentMap("oldStreet"),Game.World.moveTo(32,2,!0),Game.Display.Logs.add({text:"An abandoned street, a lone person standing underneath a rusting streetlight as the wind batters the floor."})}}},dangerousTiles:{dangerMap:Array.apply(null,Array(35)).map(e=>Array.apply(null,Array(13)).map(a=>"#")),enemies:{"#":{enemies:[{enemyName:"Snake",message:"A snake leaps from within the yellowed grass, fangs ready to draw blood.",enemyHealth:3,enemyAttacks:{attack:{name:"bite",damage:3,cooldown:1,cooldownRemaining:1,logMessage:function(e,a){return"> "+a+" bit you for "+e+" damage."},probability:1},prepare:{name:"prepare",damage:0,cooldown:1,cooldownRemaining:0,logMessage:function(e,a){return"> The snake rears up, ready to strike."},probability:1}},loot:[{id:"meat",amount:function(){return Math.random()>.5?2:1}}],onVictory:function(){console.log("Victory")},probability:.07},{enemyName:"Fox",message:"A fox snarls, defending its territory.",enemyHealth:5,enemyAttacks:{attack:{name:"",damage:1,cooldown:0,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" attacked you for "+e+" damage."},probability:1}},loot:[{id:"meat",amount:function(){return Math.random()>.5?1:0}},{id:"fur",amount:function(){return Math.random()>.5?2:1}}],onVictory:function(){console.log("Victory")},probability:.07},{enemyName:"Lizard",message:"A lizard spits out its forked tongue to attack.",enemyHealth:3,enemyAttacks:{attack:{name:"Attack",damage:2,cooldown:0,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" attacked you for "+e+" damage."},probability:1}},loot:[{id:"meat",amount:function(){return Math.random()>.5?1:0}},{id:"wood",amount:function(){return Math.random()>.5?2:1}}],onVictory:function(){console.log("Victory")},probability:.07}]}}}},entranceToCity:{name:"Entrance to City",map:["#######################".split(""),"#..........D..........#".split(""),"#.....................#".split(""),"#.....................#".split(""),"######,,,,,,,,,,,######".split(""),"     #,,,,,,,,,,,#     ".split(""),"     #,,,,,,,,,,,#     ".split(""),"     #,,,,,D,,,,,#     ".split(""),"     #############     ".split("")],uncovered:Array.apply(null,Array(10)).map(e=>Array.apply(null,Array(23)).map(a=>!0)),usedSpecialTiles:{},unlockedDoors:{},tileEffects:{11:{1:function(){Game.Engine.exitEntranceToCity()},7:function(){Game.World.setCurrentMap("pathToCity"),Game.World.moveTo(6,1,!0),Game.Display.Logs.add({text:"A long and dusty path, tread by only a daring few, the artificial night hiding dangers in the sea of dying grass."})}}},dangerousTiles:{dangerMap:Array.apply(null,Array(10)).map(e=>Array.apply(null,Array(23)).map(a=>" ")),enemies:{}}},cityCenter:{name:"City Center",map:["     #####################################     ".split(""),"     #.................B.................#     ".split(""),"     #...................................#     ".split(""),"     #...................................#     ".split(""),"     #.........N.........................#     ".split(""),"     #...................................#     ".split(""),"     #...................................#     ".split(""),"######...................................######".split(""),"#.............................................#".split(""),"#D...........................................D#".split(""),"#.............................................#".split(""),"######.....................B.............######".split(""),"     #...................................#     ".split(""),"     #...................................#     ".split(""),"     #B..................................#     ".split(""),"     #...................................#     ".split(""),"     #...................................#     ".split(""),"     #.................N..............B..#     ".split(""),"     #####################################     ".split("")],uncovered:Array.apply(null,Array(19)).map(e=>Array.apply(null,Array(47)).map(a=>!1)),usedSpecialTiles:{6:{14:!1},15:{4:!1},23:{1:!1,17:!1},27:{11:!1},38:{17:!1}},unlockedDoors:{},tileEffects:{1:{9:function(){Game.Resources.ResourceData.find(e=>e.id==="key").amount?Game.Display.Logs.add({text:"Wrong door, the guards say. This is a permit to leave via the door on the opposite side."}):Game.Display.Logs.add({text:"The door is locked, and the guards do not let you out."})}},6:{14:function(){Game.World.Map.usedSpecialTiles[6][14]||(Game.World.Map.usedSpecialTiles[6][14]=!0,Game.Events.cityCenterBinEvent())}},15:{4:function(){Game.World.Map.usedSpecialTiles[15][4]?Game.Display.Logs.add({text:"The teenager, objective complete and your piece of iron in hand, ignores you."}):Game.Resources.ResourceData.find(e=>e.id==="iron").amount>1?Game.Events.cityCenterTeenagerEvent():Game.Display.Logs.add({text:"The teenager, self-conceited as they all are, simply ignores you."})}},23:{1:function(){Game.World.Map.usedSpecialTiles[23][1]||(Game.World.Map.usedSpecialTiles[23][1]=!0,Game.Events.cityCenterBinEvent())},17:function(){Game.World.Map.usedSpecialTiles[23][17]?Game.Display.Logs.add({text:"Business done, the permit dealer ignores you."}):Game.Resources.ResourceData.find(e=>e.id==="virbuck").amount?Game.Events.cityCenterPermitDealerEvent():Game.Display.Logs.add({text:"The permit dealer is happy to give you a permit to exit this place, well at least if you pay the money first."})}},27:{11:function(){Game.World.Map.usedSpecialTiles[27][11]||(Game.World.Map.usedSpecialTiles[27][11]=!0,Game.Events.cityCenterBinEvent())}},38:{17:function(){Game.World.Maps.cityCenter.usedSpecialTiles[38][17]||(Game.World.Maps.cityCenter.usedSpecialTiles[38][17]=!0,Game.Events.cityCenterBinEvent())}},45:{9:function(){Game.Resources.ResourceData.find(e=>e.id==="key").amount?Game.Events.cityCenterExitEvent():Game.Display.Logs.add({text:"The guards raise their weapons. The Shades are out there, they say. You will need a permit to get out, which can be purchased from the permit dealer at a price."})}}},dangerousTiles:{dangerMap:Array.apply(null,Array(19)).map(e=>Array.apply(null,Array(47)).map(a=>" ")),enemies:{}}},leaveCityPath:{name:"Leave City Path",map:["#########                        ".split(""),"#,,,D,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#########################".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#########################,,,,,,,#".split(""),"                        #,,,,,,,#".split(""),"                        #,,,,,,,#".split(""),"                        #,,,,,,,#".split(""),"                        #,,,,,,,#".split(""),"                        #,,,,,,,#".split(""),"                        #,,,,,,,#".split(""),"#########################,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,#########################".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,,,,,#                        ".split(""),"#,,,D,,,#                        ".split(""),"#########                        ".split("")],uncovered:Array.apply(null,Array(45)).map(e=>Array.apply(null,Array(33)).map(a=>!0)),usedSpecialTiles:{},unlockedDoors:{4:{1:!1,43:!1}},tileEffects:{4:{43:function(){Game.Display.Logs.add({text:"The steel gate is locked, and the guards do not let you back in."})},1:function(){Game.Engine.exitLeaveCityPath()}}},dangerousTiles:{dangerMap:Array.apply(null,Array(45)).map(e=>Array.apply(null,Array(33)).map(a=>"#")),enemies:{"#":{enemies:[{enemyName:"Wolf",message:"A wolf pounces from the shadows.",enemyHealth:5,enemyAttacks:{attack:{name:"bite",damage:2,cooldown:0,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" bit you for "+e+" damage."},probability:1}},loot:[{id:"meat",amount:function(){return Math.random()>.5?2:1}},{id:"fur",amount:function(){return Math.random()>.5?3:2}},{id:"iron",amount:function(){return Math.random()>.5?1:0}}],onVictory:function(){console.log("Victory")},probability:.03},{enemyName:"Giant Lizard",message:"A giant lizard covered with spiny scales attacks.",enemyHealth:10,enemyAttacks:{attack:{name:"attack",damage:1,cooldown:0,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" attacked you for "+e+" damage."},probability:1}},loot:[{id:"meat",amount:function(){return Math.random()>.5?2:1}},{id:"wood",amount:function(){return Math.random()>.5?3:2}},{id:"iron",amount:function(){return Math.random()>.5?1:0}}],onVictory:function(){console.log("Victory")},probability:.03},{enemyName:"Bird",message:"A strange bird armed with a sharp beak approaches.",enemyHealth:5,enemyAttacks:{attack:{name:"attack",damage:4,cooldown:1,cooldownRemaining:1,logMessage:function(e,a){return"> "+a+" pecked you for "+e+" damage."},probability:1},prepare:{name:"prepare",damage:0,cooldown:1,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" prepares to strike."},probability:1}},loot:[{id:"meat",amount:function(){return Math.random()>.5?2:1}},{id:"string",amount:function(){return 1}},{id:"iron",amount:function(){return Math.random()>.5?1:0}}],onVictory:function(){console.log("Victory")},probability:.03}]}}}},entranceToShadeHeadquarters:{name:"Entrance to Shade Headquarters",map:["#######################".split(""),"#,,,,,,,...D...,,,,,,,#".split(""),"#,,,,,,,,.....,,,,,,,,#".split(""),"#,,,,,,,,,,.,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,#".split(""),"#,,,,,,,,,,,,,,,,,,,,,#".split(""),"######,,,,,,,,,,,######".split(""),"     #,,,,,,,,,,,#     ".split(""),"     #,,,,,,,,,,,#     ".split(""),"     #,,,,,D,,,,,#     ".split(""),"     #############     ".split("")],uncovered:Array.apply(null,Array(12)).map(e=>Array.apply(null,Array(23)).map(a=>!1)),usedSpecialTiles:{},unlockedDoors:{},tileEffects:{11:{1:function(){Game.Engine.exitEntranceToShadeHeadquarters()},10:function(){Game.World.setCurrentMap("leaveCityPath"),Game.World.moveTo(4,1,!0),Game.Display.Logs.add({text:"The cold winter winds scour the land. A long and winding path stretches out, enemies lurking in the long grass."})}}},dangerousTiles:{dangerMap:Array.apply(null,Array(12)).map(e=>Array.apply(null,Array(23)).map(a=>" ")),enemies:{}}},shadeHeadquarters:{name:"Shade Headquarters",map:["#################################".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#D..............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#########################.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"#########################.......#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#.......#########################".split(""),"#.......#                        ".split(""),"#.......#                        ".split(""),"#.......#                        ".split(""),"#.......#                        ".split(""),"#.......#                        ".split(""),"#.......#                        ".split(""),"#.......#########################".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#...............................#".split(""),"#########################.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #.......#".split(""),"                        #...D...#".split(""),"                        #########".split("")],uncovered:Array.apply(null,Array(51)).map(e=>Array.apply(null,Array(33)).map(a=>!1)),usedSpecialTiles:{},unlockedDoors:{1:{4:!1},28:{49:!1}},tileEffects:{1:{4:function(){Game.Engine.exitShadeHeadquarters()}},28:{49:function(){Game.Display.Logs.add({text:"The alloy door is shut. The only way to go is forward."})}}},dangerousTiles:{dangerMap:Array.apply(null,Array(51)).map(e=>Array.apply(null,Array(33)).map(a=>"#")),enemies:{"#":{enemies:[{enemyName:"Shade Bot",message:"A Shade bot, armed with a sharp spinning blade, walks up to you.",enemyHealth:25,enemyAttacks:{attack:{name:"slash",damage:3,cooldown:0,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" slashed you for "+e+" damage."},probability:1}},loot:[{id:"alloy",amount:function(){return Math.random()>.5?2:1}},{id:"iron",amount:function(){return Math.random()>.5?3:2}}],onVictory:function(){console.log("Victory")},probability:.04},{enemyName:"Shade Bot",message:"A Shade bot, armed with a powerful red laser, walks up to you.",enemyHealth:20,enemyAttacks:{attack:{name:"attack",damage:7,cooldown:2,cooldownRemaining:2,logMessage:function(e,a){return"> "+a+" laser beamed you for "+e+" damage."},probability:1},prepare:{name:"prepare",damage:0,cooldown:2,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" raises its laser for another blow."},probability:1},prepare2:{name:"prepare",damage:0,cooldown:2,cooldownRemaining:1,logMessage:function(e,a){return"> "+a+"'s laser glows red with energy."},probability:1}},loot:[{id:"alloy",amount:function(){return Math.random()>.5?2:1}},{id:"iron",amount:function(){return Math.random()>.5?3:2}}],onVictory:function(){console.log("Victory")},probability:.04},{enemyName:"Shade Bot",message:"A Shade bot, armed with a big iron shield, walks up to you.",enemyHealth:40,enemyAttacks:{attack:{name:"attack",damage:1,cooldown:0,cooldownRemaining:0,logMessage:function(e,a){return"> "+a+" smashed you for "+e+" damage."},probability:1}},loot:[{id:"alloy",amount:function(){return Math.random()>.5?2:1}},{id:"iron",amount:function(){return Math.random()>.5?3:2}}],onVictory:function(){console.log("Victory")},probability:.03}]}}}},pathfinder:{name:"The Pathfinder",map:["#####################".split(""),"#...................#".split(""),"#...................#".split(""),"#...................#".split(""),"#.........F.........#".split(""),"#...................#".split(""),"#...................#".split(""),"#..................D#".split(""),"#####################".split("")],uncovered:Array.apply(null,Array(9)).map(e=>Array.apply(null,Array(21)).map(a=>!1)),usedSpecialTiles:{},unlockedDoors:{},tileEffects:{10:{4:function(){Game.Engine.pathfinder()}},19:{7:function(){Game.World.setCurrentMap("shadeHeadquarters"),Game.World.moveTo(1,4,!0),Game.Display.Logs.add({text:"Shattered Shade robots lie on the stone floor, defeated and banished from their own headquarters. Only a few robots remain."})}}},dangerousTiles:{dangerMap:Array.apply(null,Array(9)).map(e=>Array.apply(null,Array(21)).map(a=>" ")),enemies:{}}},end:{name:"The End",map:["#####".split(""),"#...#".split(""),"#.S.#".split(""),"#...#".split(""),"#####".split("")],uncovered:Array.apply(null,Array(5)).map(e=>Array.apply(null,Array(5)).map(a=>!0)),usedSpecialTiles:{},unlockedDoors:{},tileEffects:{},dangerousTiles:{dangerMap:Array.apply(null,Array(5)).map(e=>Array.apply(null,Array(5)).map(a=>" ")),enemies:{}}}};Player={Position:{x:0,y:0},health:10};computeMaxHealth(){let e=10;return Game.Resources.ResourceData.find(a=>a.id==="furarmour").amount&&(e+=5),Game.Resources.ResourceData.find(a=>a.id==="ironarmour").amount&&(e+=15),Game.Resources.ResourceData.find(a=>a.id==="alloyarmour").amount&&(e+=20),e}computeViewDistance(){let e=4;return Game.Resources.ResourceData.find(a=>a.id==="torch").amount&&(e+=1),e}setCurrentMap(e){this.Map.name&&(this.Maps[this.Map.name].uncovered=this.Map.uncovered,this.Maps[this.Map.name].usedSpecialTiles=this.Map.usedSpecialTiles),this.Map.map=this.Maps[e].map,this.Map.name=e,this.Map.tileEffects=this.Maps[e].tileEffects,this.Map.uncovered=this.Maps[e].uncovered,this.Map.usedSpecialTiles=this.Maps[e].usedSpecialTiles,this.Map.unlockedDoors=this.Maps[e].unlockedDoors,this.Map.dangerousTiles=this.Maps[e].dangerousTiles,this.render()}uncoverTiles(){let e=this.computeViewDistance();this.Map.uncovered[this.Player.Position.y][this.Player.Position.x]=!0;let a=[{x:this.Player.Position.x,y:this.Player.Position.y}];for(let t=1;t<=e;t++){let o=[];for(let n of a)n.y-1>=0&&(this.Map.uncovered[n.y-1][n.x]=!0,o.push({x:n.x,y:n.y-1})),n.x-1>=0&&(o.push({x:n.x-1,y:n.y}),this.Map.uncovered[n.y][n.x-1]=!0),n.x+1<this.Map.map[0].length&&(o.push({x:n.x+1,y:n.y}),this.Map.uncovered[n.y][n.x+1]=!0),n.y+1<this.Map.map.length&&(this.Map.uncovered[n.y+1][n.x]=!0,o.push({x:n.x,y:n.y+1}));a=o}}moveUp(){this.Player.Position.y--,this.uncoverTiles(),this.runTileEffect(),this.tileMessage(),this.dangerousTile(),this.render()}moveDown(){this.Player.Position.y++,this.uncoverTiles(),this.runTileEffect(),this.tileMessage(),this.dangerousTile(),this.render()}moveLeft(){this.Player.Position.x--,this.uncoverTiles(),this.runTileEffect(),this.tileMessage(),this.dangerousTile(),this.render()}moveRight(){this.Player.Position.x++,this.uncoverTiles(),this.runTileEffect(),this.tileMessage(),this.dangerousTile(),this.render()}moveTo(e,a,t=!1){this.Player.Position.x=e,this.Player.Position.y=a,this.uncoverTiles(),t||this.runTileEffect(),t||this.tileMessage(),t||this.dangerousTile(),this.render()}collisionDetect(e,a){switch(this.Map.map[a][e]){case this.Tiles.WALL:return!0;default:return!1}}dangerousTile(){if(this.Map.dangerousTiles.dangerMap[this.Player.Position.y][this.Player.Position.x]===" "||this.Map.usedSpecialTiles[this.Player.Position.x]!==void 0&&this.Map.usedSpecialTiles[this.Player.Position.x][this.Player.Position.y]!==void 0||this.Map.unlockedDoors[this.Player.Position.x]!==void 0&&this.Map.unlockedDoors[this.Player.Position.x][this.Player.Position.y]!==void 0)return;let e=this.Map.dangerousTiles.enemies[this.Map.dangerousTiles.dangerMap[this.Player.Position.y][this.Player.Position.x]].enemies,a=Math.random(),t=null;for(let o in e)if(a>e[o].probability)a-=e[o].probability;else{t=e[o];break}t!==null&&(Game.Display.Logs.add({text:t.message}),Game.Events.createCombatEvent({enemyName:t.enemyName,enemyHealth:t.enemyHealth,enemyAttacks:t.enemyAttacks,chainEvent:!0,onVictory:function(){t.onVictory()},onEnd:function(){let o=[];for(let n in t.loot){let r=t.loot[n].amount();r&&o.push({id:t.loot[n].id,amount:r})}Game.Events.createItemPickupEvent({name:"Loot "+t.enemyName,description:t.enemyName+" is dead. You could use some of the resources for yourself.",items:o})}}))}runTileEffect(){this.Map.tileEffects[this.Player.Position.x]&&this.Map.tileEffects[this.Player.Position.x][this.Player.Position.y]&&this.Map.tileEffects[this.Player.Position.x][this.Player.Position.y]()}tileMessage(){if(this.Map.map[this.Player.Position.y][this.Player.Position.x]!==this.lastTile){let e=this.Map.map[this.Player.Position.y][this.Player.Position.x];e===this.Tiles.STONE_FLOOR?Game.Display.Logs.add({text:"The cold stone floor shines a dull, unforgiving gray."}):e===this.Tiles.WOODEN_PLANK?Game.Display.Logs.add({text:"The aged wooden planks creaks with every step."}):e===this.Tiles.WOODEN_PLANK?Game.Display.Logs.add({text:"The dried grass, yellowed and dying, sways in the gentle breeze."}):e===this.Tiles.PATHFINDER&&Game.Display.Logs.add({text:"You step into the Pathfinder. The strange, mysterious technology lies dormant."}),this.lastTile=e}if(this.Map.dangerousTiles.dangerMap[this.Player.Position.y][this.Player.Position.x]!==this.lastDangerTile){let e=this.Map.dangerousTiles.dangerMap[this.Player.Position.y][this.Player.Position.x];if(this.lastDangerTile=e,e===" ")return;Game.Display.Logs.add({text:"You sense unseen danger lurking in the shadows, ready to strike at the most unexpected."})}}render(){this.mapString="";let e=!1;this.Map.map.length<50&&(this.mapString+="<br/>".repeat(Math.ceil((50-this.Map.map.length)/2)));function a(){e||(Game.World.mapString+='<span class="text-black">',e=!0)}function t(){e&&(e=!1,Game.World.mapString+="</span>")}for(let o in this.Map.map){for(let n in this.Map.map[o]){if(Number(o)===this.Player.Position.y&&Number(n)===this.Player.Position.x){this.mapString+='<span class="text-black"><b>@</b></span>';continue}if(this.Map.uncovered[o][n])switch(this.Map.map[o][n]){case this.Tiles.STONE_FLOOR:t(),this.mapString+=this.Tiles.STONE_FLOOR;break;case this.Tiles.WOODEN_PLANK:t(),this.mapString+=this.Tiles.WOODEN_PLANK;break;case this.Tiles.GRASS:t(),this.mapString+=this.Tiles.GRASS;break;case this.Tiles.WALL:a(),this.mapString+=this.Tiles.WALL;break;case this.Tiles.DOOR:a(),this.mapString+=this.Tiles.DOOR;break;case this.Tiles.SPAWN:a(),this.mapString+=this.Tiles.SPAWN;break;case this.Tiles.ITEM:this.Map.usedSpecialTiles[n][o]?t():a(),this.mapString+=this.Tiles.ITEM;break;case this.Tiles.BOX:this.Map.usedSpecialTiles[n][o]?t():a(),this.mapString+=this.Tiles.BOX;break;case this.Tiles.PERSON:this.Map.usedSpecialTiles[n][o]?t():a(),this.mapString+=this.Tiles.PERSON;break;case this.Tiles.PATHFINDER:a(),this.mapString+=this.Tiles.PATHFINDER;break;case this.Tiles.PATH:t(),this.mapString+=this.Tiles.PATH;break;case this.Tiles.WHITESPACE:t(),this.mapString+="&nbsp;";break;default:console.log("Unknown tile, probably typo")}else e&&(e=!1,this.mapString+="</span>"),this.mapString+="&nbsp;"}this.mapString+="<br/>"}this.Map.map.length<50&&(this.mapString+="<br/>".repeat(Math.floor((50-this.Map.map.length)/2))),Game.Renderer.updateMap()}};var v=class{init(){Game.Renderer.updateResources(),Game.World.setCurrentMap("introduction"),Game.World.moveTo(7,5),Game.Command.setCommandHandler(Game.Command.worldCommandHandler),Game.Display.Logs.add({text:`
            The chilling air freezes deep within your heart, the fading sunlight casts a long shadow over the door ahead of you from gaps in rusting iron bars.<br/>
            You have no idea how you got here, your memory seems to have been wiped.<br/>
            All that you can remember is an inexplicable longing to find <em>something</em>, no matter how perilous the path, but you cannot remember exactly what nor why.<br/>
            You reach for your pockets, and a battered guidebook materialises. Perhaps using the command [help] can guide your journey.<br/>
            `})}gameOver(){Game.Renderer.gameOver(),setTimeout(()=>document.getElementById("gameOver").classList.remove("hidden"),1e3)}exitIntroduction(){Game.Events.introductionEvent()}exitCorridor(){Game.World.Maps.corridor.unlockedDoors[40][10]?(Game.World.setCurrentMap("library"),Game.World.moveTo(11,48,!0),Game.Display.Logs.add({text:"Rows upon rows of bookshelves appear, covered with dust and cobwebs after years of abandonment."})):Game.Events.corridorExitEvent()}exitLibrary(){Game.World.Maps.library.unlockedDoors[44][16]?(Game.World.setCurrentMap("computerRoom"),Game.World.moveTo(7,7,!0),Game.Display.Logs.add({text:"Piles of abandoned computer equipment, once blinking lights extinguished, once whirring disks silent."})):Game.Events.libraryExitEvent()}exitComputerRoom(){Game.World.Maps.computerRoom.unlockedDoors[13][1]?(Game.World.setCurrentMap("oldStreet"),Game.World.moveTo(2,7,!0),Game.Display.Logs.add({text:"An abandoned street, a lone person standing underneath a rusting streetlight as the wind batters the floor."})):Game.Events.computerRoomExitEvent()}exitOldStreet(){Game.World.Maps.oldStreet.unlockedDoors[32][2]?(Game.World.setCurrentMap("pathToCity"),Game.World.moveTo(6,33,!0),Game.Display.Logs.add({text:"A long and dusty path, tread by only a daring few, the artificial night hiding dangers in the sea of dying grass."})):Game.World.Maps.oldStreet.usedSpecialTiles[9][1]?(Game.World.setCurrentMap("pathToCity"),Game.World.moveTo(6,33,!0),Game.Display.Logs.add({text:"A long and dusty path, tread by only a daring few, the artificial night hiding dangers in the sea of dying grass. A silhouette of a great city faintly appears on the distant horizon."}),Game.World.Maps.oldStreet.unlockedDoors[32][2]=!0):Game.Display.Logs.add({text:"You look at the person standing beneath the streetlamp. Perhaps she knows some useful information."})}exitPathToCity(){Game.World.Maps.pathToCity.unlockedDoors[6][1]?(Game.World.setCurrentMap("entranceToCity"),Game.World.moveTo(11,7,!0),Game.Display.Logs.add({text:"The entrance of the city of dreams stands right ahead, guardian to the isolated world inside."})):Game.Events.pathToCityExitEvent()}exitEntranceToCity(){Game.Events.entranceToCityExitEvent()}exitCityCenter(){Game.Events.cityCenterExitEvent()}exitLeaveCityPath(){Game.World.Maps.leaveCityPath.unlockedDoors[4][1]?(Game.World.setCurrentMap("entranceToCity"),Game.World.moveTo(11,7,!0),Game.Display.Logs.add({text:"The entrance of the city of dreams stands right ahead, guardian to the isolated world inside."})):Game.Events.leaveCityPathExitEvent()}exitEntranceToShadeHeadquarters(){Game.Events.entranceToShadeHeadquartersExitEvent()}exitShadeHeadquarters(){Game.World.setCurrentMap("pathfinder"),Game.World.moveTo(19,7,!0),Game.World.Maps.shadeHeadquarters.unlockedDoors[1][4]?Game.Display.Logs.add({text:"The Pathfinder gleams a beautiful silver, a glass cylinder the size of a person with knobs and levers scattered around."}):(Game.Display.Logs.add({text:"The torrents upon torrents of Shade bots now lie broken on the cold stone floor. The Pathfinder gleams a beautiful silver, a glass cylinder the size of a person with knobs and levers scattered around. This is the key to finding Virbox."}),Game.World.Maps.shadeHeadquarters.unlockedDoors[1][4]=!0)}pathfinder(){Game.Resources.ResourceData.find(e=>e.id==="crystal").amount?Game.Events.pathfinderLeaveEvent():Game.Resources.ResourceData.find(e=>e.id==="jsengine").amount?Game.Events.pathfinderRepairEvent():Game.Resources.ResourceData.find(e=>e.id==="jsfragment").amount===5?Game.Display.Logs.add({text:"The Pathfinder is broken beyond all known repair. Perhaps [craft] a JS engine."}):Game.Events.pathfinderFindEvent()}endgame(){Game.Events.fightMacro()}};var h={Command:null,World:null,Renderer:null,Resources:null,Display:null,Engine:null,Events:null};window.Game=h;h.Renderer=new g;h.Display=new b;h.Command=new k;h.Resources=new G;h.Events=new w;h.World=new x;h.Engine=new v;h.Command.listenForCommands();document.getElementById("command").focus();document.addEventListener("alpine:init",()=>{Alpine.data("Game",()=>({Resources:{ResourceData:structuredClone(h.Resources.ResourceData)},World:{mapString:""},Display:{Logs:{logs:[]}},UI:{Modal:{showModal:!1,title:"",currentScene:"main",scenes:{main:{text:"",actions:[]}}},Resources:{maxSpace:0,freeSpace:0},gameOver:!1}}))});document.addEventListener("alpine:initialized",()=>{h.Engine.init()});})();
